{% extends "base.html" %}

{% block header_left %}
    {% if projects %}
        <select id="project-select" class="form-select form-select-sm bg-dark text-light border-secondary" style="min-width:220px;">
            {% for project in projects %}
                <option value="{{ project.id }}" data-slug="{{ project.slug }}" {% if current_project and project.id == current_project.id %}selected{% endif %}>
                    {{ project.name }}
                </option>
            {% endfor %}
        </select>
    {% else %}
        <span class="text-secondary small">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–æ–≤</span>
    {% endif %}
{% endblock %}

{% block content %}
<div class="cc-chat-layout">
    <div class="cc-column" data-col="left">
        <section class="cc-panel"
                 id="agents-panel"
                 data-current-project-id="{% if current_project %}{{ current_project.id }}{% endif %}"
                 data-current-project-slug="{% if current_project %}{{ current_project.slug }}{% endif %}"
                 data-initial-agent-id="{% if initial_agent %}{{ initial_agent.id }}{% endif %}">
            <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
                <div>
                    <div class="fw-semibold">–ê–≥–µ–Ω—Ç—ã</div>
                    {% if current_project %}
                        <small class="text-light text-opacity-75">{{ current_project.name }}</small>
                    {% endif %}
                </div>
                <span class="badge bg-info text-dark">{{ agents|length }} –∞–∫—Ç–∏–≤–Ω—ã—Ö</span>
            </div>
            <div id="agents-list" class="agent-list">
                {% for agent in agents %}
                    <button type="button"
                            class="agent-item"
                            data-agent-id="{{ agent.id }}"
                            data-is-primary="{% if agent.is_primary %}1{% else %}0{% endif %}">
                        <span class="fw-semibold">{{ agent.name }}</span>
                        <span class="badge {% if agent.is_primary %}bg-success{% else %}bg-secondary text-light{% endif %}">
                            {% if agent.project_id %}–ª–æ–∫–∞–ª—å–Ω—ã–π{% else %}–≥–ª–æ–±–∞–ª—å–Ω—ã–π{% endif %}
                        </span>
                    </button>
                {% empty %}
                    <div class="text-secondary small">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤</div>
                {% endfor %}
            </div>
        </section>
    </div>

    <div class="cc-column" data-col="center">
        <section class="cc-panel" id="agent-memory-panel" style="display:none;">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-semibold">–ü–∞–º—è—Ç—å –∞–≥–µ–Ω—Ç–∞</span>
                <button type="button" id="agent-memory-refresh" class="btn btn-outline-light btn-sm" style="display:none;">–û–±–Ω–æ–≤–∏—Ç—å</button>
            </div>
            <div id="agent-memory-status" class="text-secondary small mb-2">
                {% if current_project %}
                    –í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –µ–≥–æ –ø–∞–º—è—Ç—å.
                {% else %}
                    –°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç.
                {% endif %}
            </div>
            <ul id="agent-memory-list" class="list-group list-group-flush small"></ul>
        </section>

        <section class="cc-panel mt-3" id="agent-graph-panel">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <span class="fw-semibold">Graph Memory</span>
                <div class="d-flex gap-2">
                    <button type="button" id="agent-graph-refresh" class="btn btn-outline-light btn-sm" style="display:none;">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    <button type="button" id="agent-graph-pin-toggle" class="btn btn-outline-info btn-sm text-dark" style="display:none;">–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ pinned</button>
                </div>
            </div>
            <div id="graph-overview" class="rounded-4 border border-secondary-subtle bg-dark bg-opacity-75 p-3 mb-3" style="display:none;">
                <div class="d-flex justify-content-between">
                    <div>
                        <div class="text-secondary">–£–∑–ª–æ–≤</div>
                        <div class="h4 mb-0" id="graph-overview-node-count">‚Äî</div>
                    </div>
                    <div>
                        <div class="text-secondary">–°–≤—è–∑–µ–π</div>
                        <div class="h4 mb-0" id="graph-overview-edge-count">‚Äî</div>
                    </div>
                </div>
                <div class="mt-3 mb-1">–¢–æ–ø –∫–æ–Ω—Ü–µ–ø—Ç–æ–≤:</div>
                <div id="graph-overview-top-nodes" class="text-light">‚Äî</div>
                <div class="mt-2">–°–≤—è–∑–∏: <span id="graph-overview-top-relations">‚Äî</span></div>
                <div class="mt-2 text-secondary">–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="graph-overview-updated">‚Äî</span></div>
            </div>
            <div id="agent-graph-status" class="text-secondary small mb-2">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞—Ñ.</div>
            <div class="mb-2 text-secondary">–£–∑–ª—ã:</div>
            <ul id="agent-graph-nodes" class="list-group list-group-flush mb-3"></ul>
            <div class="mb-2 text-secondary">–°–≤—è–∑–∏:</div>
            <ul id="agent-graph-edges" class="list-group list-group-flush"></ul>
        </section>
    </div>

    <div class="cc-column" data-col="right">
        <section class="cc-panel" id="rag-panel"
                 data-rag-agent-id="{% if rag_agent_id %}{{ rag_agent_id }}{% endif %}"
                 data-last-sync="{% if current_project_rag_meta and current_project_rag_meta.last_full_sync %}{{ current_project_rag_meta.last_full_sync|date:'c' }}{% endif %}"
                 data-last-error="{% if current_project_rag_meta and current_project_rag_meta.last_error %}{{ current_project_rag_meta.last_error|date:'c' }}{% endif %}"
                 data-error-count="{{ current_project_rag_meta.error_count|default:0 }}"
                 style="{% if current_project %}{% else %}display:none;{% endif %}">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <span class="fw-semibold">üìö –î–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è / RAG Librarian</span>
                <div class="d-flex gap-2 flex-wrap justify-content-end">
                    <button type="button" id="rag-agent-btn"
                            class="btn btn-outline-info btn-sm text-dark">ü§ñ –ü–æ–ø—Ä–æ—Å–∏—Ç—å –∞–≥–µ–Ω—Ç–∞</button>
                    <button type="button" id="rag-ingest-btn"
                            class="btn btn-info btn-sm text-dark">üß† –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å</button>
                    <button type="button" id="rag-refresh-btn"
                            class="btn btn-outline-light btn-sm">üîÑ –°–ø–∏—Å–æ–∫</button>
                </div>
            </div>
            <div class="small">
                {% if not current_project %}
                    <p class="text-secondary mb-0">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç, —á—Ç–æ–±—ã —É–ø—Ä–∞–≤–ª—è—Ç—å –∏–Ω–¥–µ–∫—Å–æ–º –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏.</p>
                {% else %}
                    <div id="rag-meta-info" class="mb-3">
                        <div>–ü–æ—Å–ª–µ–¥–Ω–∏–π –ø–æ–ª–Ω—ã–π —Å–∏–Ω–∫: <span id="rag-meta-sync">{% if current_project_rag_meta and current_project_rag_meta.last_full_sync %}{{ current_project_rag_meta.last_full_sync|date:"Y-m-d H:i" }}{% else %}‚Äî{% endif %}</span></div>
                        <div>–û—à–∏–±–æ–∫: <span id="rag-meta-errors">{{ current_project_rag_meta.error_count|default:0 }}</span></div>
                    </div>
                    <div id="rag-error-banner" class="alert alert-warning py-2 small" style="display:{% if current_project_rag_meta and current_project_rag_meta.error_count %}block{% else %}none{% endif %};">
                        ‚ö† –ï—Å—Ç—å –ø—Ä–æ–±–ª–µ–º–Ω—ã–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã. –ù–∞–∂–º–∏—Ç–µ ¬´ü§ñ –ü–æ–ø—Ä–æ—Å–∏—Ç—å RAG-–∞–≥–µ–Ω—Ç–∞¬ª, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å.
                    </div>
                    <div class="mb-3 text-secondary" id="rag-status">–§–∞–π–ª—ã –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å.</div>
                    <div class="table-responsive">
                        <table class="table table-dark table-sm align-middle">
                            <thead class="text-secondary">
                                <tr>
                                    <th>–§–∞–π–ª</th>
                                    <th>–°—Ç–∞—Ç—É—Å</th>
                                    <th>MIME</th>
                                    <th>–û–±–Ω–æ–≤–ª–µ–Ω–æ</th>
                                    <th>–û—à–∏–±–∫–∞</th>
                                </tr>
                            </thead>
                            <tbody id="rag-sources-body">
                                <tr>
                                    <td colspan="5" class="text-secondary">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="fw-semibold">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è</span>
                            <button type="button" id="rag-changelog-refresh" class="btn btn-outline-light btn-sm">üîÑ –û–±–Ω–æ–≤–∏—Ç—å changelog</button>
                        </div>
                        <div id="rag-changelog-status" class="text-secondary small mb-2">–ò–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å.</div>
                        <div class="table-responsive">
                            <table class="table table-dark table-sm align-middle">
                                <thead>
                                    <tr>
                                        <th>–í—Ä–µ–º—è</th>
                                        <th>–§–∞–π–ª</th>
                                        <th>–¢–∏–ø</th>
                                        <th>–°–≤–æ–¥–∫–∞</th>
                                    </tr>
                                </thead>
                                <tbody id="rag-changelog-body">
                                    <tr>
                                        <td colspan="4" class="text-secondary">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö.</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                {% endif %}
            </div>
        </section>

        <section class="cc-panel">
            <div class="fw-semibold mb-2">–ü–∞–º—è—Ç—å –ø—Ä–æ–µ–∫—Ç–∞ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ —Å–æ–±—ã—Ç–∏—è)</div>
            {% if not current_project %}
                <div class="text-secondary small">–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –∂—É—Ä–Ω–∞–ª –ø–∞–º—è—Ç–∏.</div>
            {% else %}
                <ul class="list-group list-group-flush">
                    {% for event in memory_events %}
                        <li class="list-group-item bg-dark text-light">
                            <div class="d-flex justify-content-between">
                                <span class="text-secondary small">{{ event.created_at|date:"Y-m-d H:i" }}</span>
                                <span class="badge bg-secondary text-light">{{ event.get_type_display }}</span>
                            </div>
                            <div class="mt-2">{{ event.content }}</div>
                        </li>
                    {% empty %}
                        <li class="list-group-item bg-dark text-secondary">–ü–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π –ø–∞–º—è—Ç–∏.</li>
                    {% endfor %}
                </ul>
            {% endif %}
        </section>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        const projectSelect = document.getElementById("project-select");
        const agentsPanel = document.getElementById("agents-panel");
        const agentsList = document.getElementById("agents-list");
        const agentMemoryPanel = document.getElementById("agent-memory-panel");
        const agentMemoryList = document.getElementById("agent-memory-list");
        const agentMemoryStatus = document.getElementById("agent-memory-status");
        const agentMemoryRefresh = document.getElementById("agent-memory-refresh");
        const agentGraphPanel = document.getElementById("agent-graph-panel");
        const agentGraphNodes = document.getElementById("agent-graph-nodes");
        const agentGraphEdges = document.getElementById("agent-graph-edges");
        const agentGraphStatus = document.getElementById("agent-graph-status");
        const agentGraphRefresh = document.getElementById("agent-graph-refresh");
        const agentGraphPinToggle = document.getElementById("agent-graph-pin-toggle");
        const graphOverview = document.getElementById("graph-overview");
        const graphOverviewNodeCount = document.getElementById("graph-overview-node-count");
        const graphOverviewEdgeCount = document.getElementById("graph-overview-edge-count");
        const graphOverviewTopNodes = document.getElementById("graph-overview-top-nodes");
        const graphOverviewTopRelations = document.getElementById("graph-overview-top-relations");
        const graphOverviewUpdated = document.getElementById("graph-overview-updated");

        const ragPanel = document.getElementById("rag-panel");
        const ragStatus = document.getElementById("rag-status");
        const ragMetaSync = document.getElementById("rag-meta-sync");
        const ragMetaErrors = document.getElementById("rag-meta-errors");
        const ragErrorBanner = document.getElementById("rag-error-banner");
        const ragRefreshBtn = document.getElementById("rag-refresh-btn");
        const ragIngestBtn = document.getElementById("rag-ingest-btn");
        const ragAgentBtn = document.getElementById("rag-agent-btn");
        const ragSourcesBody = document.getElementById("rag-sources-body");
        const ragChangelogBody = document.getElementById("rag-changelog-body");
        const ragChangelogStatus = document.getElementById("rag-changelog-status");
        const ragChangelogRefresh = document.getElementById("rag-changelog-refresh");

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(";").shift();
        }

        if (projectSelect) {
            const urlParams = new URLSearchParams(window.location.search);
            const urlProject = urlParams.get("project");
            const storedProject = window.localStorage.getItem("current_project_id");

            if (!urlProject && storedProject) {
                const option = Array.from(projectSelect.options).find(o => o.value === storedProject);
                if (option) {
                    urlParams.set("project", storedProject);
                    window.location.search = urlParams.toString();
                }
            }

            projectSelect.addEventListener("change", () => {
                const value = projectSelect.value;
                if (value) {
                    window.localStorage.setItem("current_project_id", value);
                    const params = new URLSearchParams(window.location.search);
                    params.set("project", value);
                    window.location.search = params.toString();
                }
            });
        }

        let currentProjectId = agentsPanel ? agentsPanel.dataset.currentProjectId || null : null;
        let currentProjectSlug = agentsPanel ? agentsPanel.dataset.currentProjectSlug || null : null;
        let currentAgentId = agentsPanel ? agentsPanel.dataset.initialAgentId || null : null;

        function updateAgentSelection() {
            if (!agentsList) return;
            const buttons = agentsList.querySelectorAll(".agent-item");
            buttons.forEach(btn => {
                if (currentAgentId && btn.dataset.agentId === String(currentAgentId)) {
                    btn.classList.add("active");
                } else {
                    btn.classList.remove("active");
                }
            });
        }

        function resetMemoryPanel() {
            if (!agentMemoryPanel || !agentMemoryStatus || !agentMemoryList) return;
            agentMemoryPanel.style.display = currentProjectId ? "block" : "none";
            agentMemoryStatus.textContent = currentProjectId
                ? "–í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –µ–≥–æ –ø–∞–º—è—Ç—å."
                : "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç.";
            agentMemoryList.innerHTML = "";
            if (agentMemoryRefresh) {
                agentMemoryRefresh.style.display = "none";
                agentMemoryRefresh.disabled = false;
            }
            resetGraphPanel();
        }

        function resetGraphPanel() {
            if (!agentGraphPanel || !agentGraphStatus) return;
            agentGraphPanel.style.display = currentProjectId ? "block" : "none";
            agentGraphStatus.textContent = currentProjectId
                ? "–í—ã–±–µ—Ä–∏—Ç–µ –∞–≥–µ–Ω—Ç–∞, —á—Ç–æ–±—ã –∑–∞–≥—Ä—É–∑–∏—Ç—å –≥—Ä–∞—Ñ."
                : "–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç.";
            if (agentGraphNodes) agentGraphNodes.innerHTML = "";
            if (agentGraphEdges) agentGraphEdges.innerHTML = "";
            if (agentGraphRefresh) {
                agentGraphRefresh.style.display = "none";
                agentGraphRefresh.disabled = false;
            }
            if (agentGraphPinToggle) {
                agentGraphPinToggle.style.display = "none";
                agentGraphPinToggle.dataset.mode = "all";
                agentGraphPinToggle.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ pinned";
            }
        }

        async function loadAgentMemory(agentId, showLoading = true) {
            if (!agentId || !agentMemoryPanel || !agentMemoryList || !agentMemoryStatus) return;
            agentMemoryPanel.style.display = "block";
            if (agentMemoryRefresh) {
                agentMemoryRefresh.style.display = "inline-flex";
            }
            if (showLoading) {
                agentMemoryStatus.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –ø–∞–º—è—Ç–∏...";
            }
            agentMemoryList.innerHTML = "";
            try {
                const resp = await fetch(`/api/agents/${agentId}/memories/?limit=50`);
                if (!resp.ok) {
                    const text = await resp.text();
                    throw new Error(text || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–∞–º—è—Ç—å –∞–≥–µ–Ω—Ç–∞.");
                }
                const data = await resp.json();
                const memories = Array.isArray(data.memories) ? data.memories : [];
                if (!memories.length) {
                    agentMemoryStatus.textContent = "–í –ø–∞–º—è—Ç–∏ –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞–ø–∏—Å–µ–π.";
                    return;
                }
                agentMemoryStatus.textContent = `–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${memories.length} –∑–∞–ø–∏—Å–µ–π.`;
                const fragment = document.createDocumentFragment();
                memories.forEach(memory => {
                    const item = document.createElement("li");
                    item.style.marginBottom = "0.35rem";

                    const content = document.createElement("div");
                    content.textContent = memory.content || "";
                    content.style.marginBottom = "0.15rem";
                    item.appendChild(content);

                    const meta = document.createElement("div");
                    meta.style.fontSize = "0.7rem";
                    meta.style.color = "#9ca3af";
                    const importance = (memory.importance || "").toUpperCase();
                    const created = memory.created_at
                        ? new Date(memory.created_at).toLocaleString()
                        : "";
                    meta.textContent = `${importance || "NORMAL"} ¬∑ ${created}`;
                    item.appendChild(meta);

                    fragment.appendChild(item);
                });
                agentMemoryList.appendChild(fragment);
            } catch (err) {
                console.error(err);
                agentMemoryStatus.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–∞–º—è—Ç–∏.";
                agentMemoryList.innerHTML = "";
            }
        }

        async function loadAgentGraph(agentId, showLoading = true) {
            if (!agentGraphPanel || !agentGraphStatus) return;
            agentGraphPanel.style.display = "block";
            if (agentGraphRefresh) {
                agentGraphRefresh.style.display = "inline-flex";
            }
            if (agentGraphPinToggle) {
                agentGraphPinToggle.style.display = "inline-flex";
            }
            if (showLoading) {
                agentGraphStatus.textContent = "–ó–∞–≥—Ä—É–∑–∫–∞ –≥—Ä–∞—Ñ–∞...";
            }
            if (agentGraphNodes) agentGraphNodes.innerHTML = "";
            if (agentGraphEdges) agentGraphEdges.innerHTML = "";
            try {
                const mode = agentGraphPinToggle?.dataset.mode || "all";
                const params = mode === "pinned" ? "&pinned=1" : "";
                const [nodesResp, edgesResp] = await Promise.all([
                    fetch(`/api/agents/${agentId}/graph/nodes/?limit=50${params}`),
                    fetch(`/api/agents/${agentId}/graph/edges/?limit=100${params}`),
                ]);
                if (!nodesResp.ok) {
                    throw new Error(await nodesResp.text() || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —É–∑–ª—ã –≥—Ä–∞—Ñ–∞.");
                }
                if (!edgesResp.ok) {
                    throw new Error(await edgesResp.text() || "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å–≤—è–∑–∏ –≥—Ä–∞—Ñ–∞.");
                }
                const nodesData = await nodesResp.json();
                const edgesData = await edgesResp.json();
                const nodes = Array.isArray(nodesData.nodes) ? nodesData.nodes : [];
                const edges = Array.isArray(edgesData.edges) ? edgesData.edges : [];

                agentGraphStatus.textContent = `–£–∑–ª—ã: ${nodes.length}, —Å–≤—è–∑–∏: ${edges.length}`;

                if (agentGraphNodes) {
                    const fragment = document.createDocumentFragment();
                    nodes.forEach(node => {
                        const item = document.createElement("li");
                        item.style.marginBottom = "0.3rem";
                        const label = document.createElement("div");
                        label.style.fontWeight = "600";
                        label.textContent = node.label || "(–±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è)";
                        const meta = document.createElement("div");
                        meta.style.fontSize = "0.7rem";
                        meta.style.color = "#9ca3af";
                        const typePart = node.type ? `type: ${node.type}` : "type: entity";
                        const objPart = node.object_type ? ` ¬∑ ${node.object_type}#${node.object_id || ""}` : "";
                        meta.textContent = typePart + objPart;
                        item.appendChild(label);
                        if (node.description) {
                            const desc = document.createElement("div");
                            desc.style.fontSize = "0.75rem";
                            desc.textContent = node.description;
                            item.appendChild(desc);
                        }
                        item.appendChild(meta);
                        fragment.appendChild(item);
                    });
                    agentGraphNodes.appendChild(fragment);
                }

                if (agentGraphEdges) {
                    const fragment = document.createDocumentFragment();
                    edges.forEach(edge => {
                        const item = document.createElement("li");
                        item.style.marginBottom = "0.3rem";
                        const rel = document.createElement("div");
                        rel.textContent = `${edge.source_label} --${edge.relation}--> ${edge.target_label}`;
                        const meta = document.createElement("div");
                        meta.style.fontSize = "0.7rem";
                        meta.style.color = "#9ca3af";
                        const desc = edge.description ? ` (${edge.description})` : "";
                        meta.textContent = `weight: ${edge.weight}${desc}`;
                        item.appendChild(rel);
                        item.appendChild(meta);
                        fragment.appendChild(item);
                    });
                    agentGraphEdges.appendChild(fragment);
                }
            } catch (err) {
                console.error(err);
                agentGraphStatus.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥—Ä–∞—Ñ–∞.";
                if (agentGraphNodes) agentGraphNodes.innerHTML = "";
                if (agentGraphEdges) agentGraphEdges.innerHTML = "";
            }
        }

        async function loadGraphOverview(projectSlug) {
            if (!projectSlug || !graphOverview) {
                graphOverview.style.display = "none";
                return;
            }
            try {
                const resp = await fetch(`/api/projects/${projectSlug}/graph/overview/`);
                if (!resp.ok) {
                    throw new Error(await resp.text());
                }
                const data = await resp.json();
                graphOverviewNodeCount.textContent = data.nodes ?? 0;
                graphOverviewEdgeCount.textContent = data.edges ?? 0;
                const topNodes = (data.top_nodes || []).map((item) => `${item.label} (${item.usage_count || 0})`);
                graphOverviewTopNodes.textContent = topNodes.length ? topNodes.join(", ") : "‚Äî";
                const topRelations = (data.top_relations || []).map((item) => `${item.relation}: ${item.count}`);
                graphOverviewTopRelations.textContent = topRelations.length ? topRelations.join(", ") : "‚Äî";
                graphOverviewUpdated.textContent = data.updated_at
                    ? new Date(data.updated_at).toLocaleString()
                    : "‚Äî";
                graphOverview.style.display = "";
            } catch (err) {
                console.error("Failed to load graph overview", err);
                graphOverview.style.display = "none";
            }
        }

        async function loadRagSources(projectSlug, { silent = false } = {}) {
            if (!ragPanel || !ragSourcesBody || !projectSlug) {
                return;
            }
            if (!silent && ragStatus) {
                ragStatus.textContent = "–ó–∞–≥—Ä—É–∂–∞—é —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤‚Ä¶";
            }
            try {
                const resp = await fetch(`/api/projects/${projectSlug}/rag/sources/`);
                if (!resp.ok) {
                    const text = await resp.text();
                    throw new Error(text || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞");
                }
                const payload = await resp.json();
                const results = Array.isArray(payload) ? payload : payload.results || [];
                const total = typeof payload.count === "number" ? payload.count : results.length;
                ragSourcesBody.innerHTML = "";
                if (!results.length) {
                    const row = document.createElement("tr");
                    row.innerHTML = `<td colspan="5" style="padding:0.45rem;color:#9ca3af;">–§–∞–π–ª–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ.</td>`;
                    ragSourcesBody.appendChild(row);
                } else {
                    const frag = document.createDocumentFragment();
                    results.forEach((item) => {
                        const row = document.createElement("tr");
                        row.style.borderBottom = "1px solid #1f2937";
                        row.innerHTML = `
                            <td style="padding:0.35rem;font-family:monospace;">${item.relative_path || item.path}</td>
                            <td style="padding:0.35rem;">${item.status}</td>
                            <td style="padding:0.35rem;">${item.mime_type || item.mimeType || ""}</td>
                            <td style="padding:0.35rem;">${item.updated_at || item.updatedAt || ""}</td>
                            <td style="padding:0.35rem;color:#fca5a5;font-size:0.75rem;">${item.error_message || item.last_error || ""}</td>
                        `;
                        frag.appendChild(row);
                    });
                    ragSourcesBody.appendChild(frag);
                }
                if (ragStatus) {
                    ragStatus.textContent = `–§–∞–π–ª–æ–≤: ${total}`;
                }
                updateRagMeta(payload.project_meta || null);
            } catch (err) {
                console.error("Failed to load RAG sources", err);
                if (ragStatus) {
                    ragStatus.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤.";
                }
            }
        }

        async function loadRagChangelog(projectSlug, { silent = false } = {}) {
            if (!projectSlug || !ragChangelogBody) {
                return;
            }
            if (!silent && ragChangelogStatus) {
                ragChangelogStatus.textContent = "–ó–∞–≥—Ä—É–∂–∞—é –∏–∑–º–µ–Ω–µ–Ω–∏—è‚Ä¶";
            }
            try {
                const resp = await fetch(`/api/projects/${projectSlug}/rag/changelog/?page_size=20`);
                if (!resp.ok) {
                    const text = await resp.text();
                    throw new Error(text || "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ changelog");
                }
                const data = await resp.json();
                const results = Array.isArray(data) ? data : data.results || [];
                ragChangelogBody.innerHTML = "";
                if (!results.length) {
                    const row = document.createElement("tr");
                    row.innerHTML = `<td colspan="4" style="padding:0.45rem;color:#9ca3af;">–ò–∑–º–µ–Ω–µ–Ω–∏–π –µ—â—ë –Ω–µ –±—ã–ª–æ.</td>`;
                    ragChangelogBody.appendChild(row);
                } else {
                    const frag = document.createDocumentFragment();
                    results.forEach((item) => {
                        const createdAt = item.created_at
                            ? new Date(item.created_at).toLocaleString()
                            : "";
                        const row = document.createElement("tr");
                        row.style.borderBottom = "1px solid #1f2937";
                        row.innerHTML = `
                            <td style="padding:0.35rem;">${createdAt}</td>
                            <td style="padding:0.35rem;font-family:monospace;">${item.source_path || ""}</td>
                            <td style="padding:0.35rem;">${item.change_type || ""}</td>
                            <td style="padding:0.35rem;">${item.semantic_summary || ""}</td>
                        `;
                        frag.appendChild(row);
                    });
                    ragChangelogBody.appendChild(frag);
                }
                if (ragChangelogStatus) {
                    const total = Array.isArray(data) ? results.length : data.count ?? results.length;
                    ragChangelogStatus.textContent = total ? `–ó–∞–ø–∏—Å–µ–π: ${total}` : "–ò–∑–º–µ–Ω–µ–Ω–∏–π –Ω–µ—Ç.";
                }
            } catch (err) {
                console.error("Failed to load RAG changelog", err);
                if (ragChangelogStatus) {
                    ragChangelogStatus.textContent = "–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ changelog.";
                }
                if (ragChangelogBody && !ragChangelogBody.children.length) {
                    const row = document.createElement("tr");
                    row.innerHTML = `<td colspan="4" style="padding:0.45rem;color:#fca5a5;">–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è.</td>`;
                    ragChangelogBody.appendChild(row);
                }
            }
        }

        async function triggerRagIngest(projectSlug) {
            if (!projectSlug) {
                return;
            }
            if (ragStatus) {
                ragStatus.textContent = "–ó–∞–ø—É—Å–∫–∞—é –ø–µ—Ä–µ–∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é‚Ä¶";
            }
            if (ragIngestBtn) {
                ragIngestBtn.disabled = true;
            }
            try {
                const resp = await fetch(`/api/projects/${projectSlug}/rag/ingest/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken") || "",
                    },
                    body: JSON.stringify({ mode: "all" }),
                });
                if (!resp.ok) {
                    const text = await resp.text();
                    throw new Error(text || "–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞");
                }
                const data = await resp.json().catch(() => ({}));
                if (ragStatus) {
                    ragStatus.textContent =
                        data.status === "queued"
                            ? "–ò–Ω–¥–µ–∫—Å–∞—Ü–∏—è –ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∞ –≤ –æ—á–µ—Ä–µ–¥—å."
                            : "–ó–∞–ø—Ä–æ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω.";
                }
                setTimeout(() => loadRagSources(projectSlug, { silent: true }), 1500);
            } catch (err) {
                console.error("Failed to ingest docs", err);
                if (ragStatus) {
                    ragStatus.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–Ω–¥–µ–∫—Å–∞—Ü–∏—é.";
                }
            } finally {
                if (ragIngestBtn) {
                    ragIngestBtn.disabled = false;
                }
            }
        }

        async function triggerRagAgentCommand(projectId, agentId, text, projectSlug) {
            if (!projectId || !agentId) {
                if (ragStatus) {
                    ragStatus.textContent = "RAG-–∞–≥–µ–Ω—Ç –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω.";
                }
                return;
            }
            if (ragStatus) {
                ragStatus.textContent = "–û–±—Ä–∞—â–∞—é—Å—å –∫ RAG-–∞–≥–µ–Ω—Ç—É‚Ä¶";
            }
            try {
                const resp = await fetch(`/api/projects/${projectId}/assistant/chat/`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCookie("csrftoken") || "",
                    },
                    body: JSON.stringify({
                        message: text,
                        agent_id: Number(agentId),
                    }),
                });
                if (!resp.ok) {
                    const txt = await resp.text();
                    throw new Error(txt || "–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ RAG-–∞–≥–µ–Ω—Ç—É");
                }
                const data = await resp.json();
                const assistantMessage = (data.messages || []).find((m) => m.sender === "assistant");
                if (ragStatus) {
                    ragStatus.textContent = assistantMessage?.content || "RAG-–∞–≥–µ–Ω—Ç –æ—Ç–≤–µ—Ç–∏–ª.";
                }
                if (projectSlug) {
                    loadRagSources(projectSlug, { silent: true });
                }
            } catch (err) {
                console.error(err);
                if (ragStatus) {
                    ragStatus.textContent = "–ù–µ —É–¥–∞–ª–æ—Å—å –≤—ã–∑–≤–∞—Ç—å RAG-–∞–≥–µ–Ω—Ç–∞.";
                }
            }
        }

        function updateRagMeta(meta) {
            if (!meta) {
                if (ragMetaSync) ragMetaSync.textContent = "‚Äî";
                if (ragMetaErrors) ragMetaErrors.textContent = "0";
                if (ragErrorBanner) ragErrorBanner.style.display = "none";
                return;
            }
            if (ragMetaSync) {
                ragMetaSync.textContent = meta.rag_last_full_sync_at
                    ? new Date(meta.rag_last_full_sync_at).toLocaleString()
                    : "‚Äî";
            }
            if (ragMetaErrors) {
                ragMetaErrors.textContent = meta.rag_error_count ?? 0;
            }
            if (ragErrorBanner) {
                ragErrorBanner.style.display = meta.rag_error_count ? "block" : "none";
            }
        }

        if (agentsList) {
            agentsList.addEventListener("click", (event) => {
                const button = event.target.closest(".agent-item");
                if (!button) return;
                currentAgentId = button.dataset.agentId;
                updateAgentSelection();
                loadAgentMemory(currentAgentId);
                loadAgentGraph(currentAgentId);
            });

            if (!currentAgentId) {
                const primary = agentsList.querySelector('.agent-item[data-is-primary="1"]');
                const fallback = agentsList.querySelector(".agent-item");
                const initial = primary || fallback;
                if (initial) {
                    currentAgentId = initial.dataset.agentId;
                }
            }
            updateAgentSelection();
            if (currentAgentId) {
                loadAgentMemory(currentAgentId);
                loadAgentGraph(currentAgentId);
            } else {
                resetMemoryPanel();
            }
        } else {
            resetMemoryPanel();
        }

        if (agentMemoryRefresh) {
            agentMemoryRefresh.addEventListener("click", async () => {
                if (!currentAgentId) return;
                agentMemoryRefresh.disabled = true;
                try {
                    await loadAgentMemory(currentAgentId, true);
                } finally {
                    agentMemoryRefresh.disabled = false;
                }
            });
        }

        if (agentGraphRefresh) {
            agentGraphRefresh.addEventListener("click", async () => {
                if (!currentAgentId) return;
                agentGraphRefresh.disabled = true;
                try {
                    await loadAgentGraph(currentAgentId, true);
                } finally {
                    agentGraphRefresh.disabled = false;
                }
            });
        }

        if (agentGraphPinToggle) {
            agentGraphPinToggle.addEventListener("click", async () => {
                if (!currentAgentId) return;
                const currentMode = agentGraphPinToggle.dataset.mode || "all";
                if (currentMode === "all") {
                    agentGraphPinToggle.dataset.mode = "pinned";
                    agentGraphPinToggle.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ —É–∑–ª—ã";
                } else {
                    agentGraphPinToggle.dataset.mode = "all";
                    agentGraphPinToggle.textContent = "–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ pinned";
                }
                await loadAgentGraph(currentAgentId, true);
            });
        }

        if (currentProjectSlug) {
            loadGraphOverview(currentProjectSlug);
        } else if (graphOverview) {
            graphOverview.style.display = "none";
        }

        if (currentProjectSlug && ragPanel) {
            ragPanel.style.display = "";
            loadRagSources(currentProjectSlug, { silent: true });
            loadRagChangelog(currentProjectSlug, { silent: true });
            updateRagMeta({
                rag_last_full_sync_at: ragPanel.dataset.lastSync || null,
                rag_last_error_at: ragPanel.dataset.lastError || null,
                rag_error_count: Number(ragPanel.dataset.errorCount || 0),
            });
            if (ragRefreshBtn) {
                ragRefreshBtn.addEventListener("click", () => loadRagSources(currentProjectSlug));
            }
            if (ragIngestBtn) {
                ragIngestBtn.addEventListener("click", () => triggerRagIngest(currentProjectSlug));
            }
            if (ragChangelogRefresh) {
                ragChangelogRefresh.addEventListener("click", () => loadRagChangelog(currentProjectSlug));
            }
            const ragAgentId = ragPanel.dataset.ragAgentId || "";
            if (ragAgentBtn && ragAgentId) {
                ragAgentBtn.addEventListener("click", () => {
                    triggerRagAgentCommand(
                        currentProjectId,
                        ragAgentId,
                        `–û–±–Ω–æ–≤–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –∏ –¥–∞–π —Å—Ç–∞—Ç—É—Å –ø–æ –ø—Ä–æ–µ–∫—Ç—É ${currentProjectSlug}.`,
                        currentProjectSlug,
                    );
                });
            }
        } else if (ragPanel) {
            ragPanel.style.display = "none";
        }
    })();
</script>
{% endblock %}
