{% extends "base.html" %}

{% block header_left %}
    {% if projects %}
        <label for="project-select" style="font-size: 0.875rem; color:#9ca3af;">Проект:</label>
        <select id="project-select" style="background:#020617;color:#e5e7eb;border:1px solid #374151;border-radius:0.375rem;padding:0.25rem 0.5rem;font-size:0.875rem;">
            {% for project in projects %}
                <option value="{{ project.id }}" {% if current_project and project.id == current_project.id %}selected{% endif %}>
                    {{ project.name }}
                </option>
            {% endfor %}
        </select>
    {% else %}
        <span style="font-size:0.875rem;color:#9ca3af;">Нет проектов</span>
    {% endif %}
{% endblock %}

{% block content %}
    <section class="panel scroll-y" id="agents-panel"
             data-current-project-id="{% if current_project %}{{ current_project.id }}{% endif %}"
             data-initial-agent-id="{% if initial_agent %}{{ initial_agent.id }}{% endif %}">
        <div class="panel-title">Агенты</div>
        <div class="panel-subtitle">
            {% if current_project %}
                Проект: {{ current_project.name }}
            {% endif %}
        </div>
        <ul id="agents-list" style="list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:0.25rem;">
            {% for agent in agents %}
                <li>
                    <button type="button"
                            class="agent-item"
                            data-agent-id="{{ agent.id }}"
                            data-is-primary="{% if agent.is_primary %}1{% else %}0{% endif %}"
                            style="width:100%;text-align:left;background:#020617;border:1px solid #1f2937;border-radius:0.375rem;padding:0.35rem 0.5rem;font-size:0.875rem;color:#e5e7eb;cursor:pointer;">
                        <div style="display:flex;justify-content:space-between;align-items:center;gap:0.5rem;">
                            <span>{{ agent.name }}</span>
                            <span style="font-size:0.7rem;color:#9ca3af;">
                                {% if agent.project_id %}локальный{% else %}глобальный{% endif %}
                                {% if agent.is_primary %} · по умолчанию{% endif %}
                            </span>
                        </div>
                    </button>
                </li>
            {% empty %}
                <li style="font-size:0.85rem;color:#9ca3af;">Нет доступных агентов</li>
            {% endfor %}
        </ul>

        <div id="agent-details" style="margin-top:0.75rem;font-size:0.8rem;border-top:1px solid #1f2937;padding-top:0.5rem;display:none;">
            <div style="font-weight:600;margin-bottom:0.25rem;">Текущий агент</div>
            <div id="agent-details-name" style="margin-bottom:0.25rem;color:#e5e7eb;"></div>
            <div style="margin-bottom:0.35rem;">
                <span style="color:#9ca3af;">Модель (фактическая):</span>
                <span id="agent-details-resolved" style="color:#e5e7eb;"></span>
                <span id="agent-details-badge" style="margin-left:0.35rem;font-size:0.7rem;color:#9ca3af;"></span>
            </div>
            <div id="agent-warning-banner"
                 style="display:none;margin-bottom:0.35rem;font-size:0.75rem;color:#facc15;">
            </div>
            <label for="agent-model-select" style="display:block;margin-bottom:0.2rem;color:#9ca3af;">Выбрать модель:</label>
            <select id="agent-model-select"
                    style="width:100%;background:#020617;color:#e5e7eb;border:1px solid #374151;border-radius:0.375rem;padding:0.25rem 0.4rem;font-size:0.8rem;">
                <option value="">Загрузка списка моделей…</option>
            </select>
            <button type="button" id="agent-model-save"
                    style="margin-top:0.4rem;background:#2563eb;border:none;color:#e5e7eb;border-radius:0.375rem;padding:0.3rem 0.7rem;font-size:0.8rem;cursor:pointer;">
                Сохранить
            </button>
            <div id="agent-details-status" style="margin-top:0.25rem;color:#9ca3af;"></div>
        </div>
    </section>

    <section class="panel" id="chat-panel">
        <div class="panel-title">Чат</div>
        <div id="chat-messages"
             style="border:1px solid #1f2937;border-radius:0.5rem;padding:0.5rem;height:calc(100% - 84px);overflow-y:auto;background:#020617;margin-bottom:0.5rem;font-size:0.875rem;">
        </div>
        <form id="chat-form" autocomplete="off" style="display:flex;gap:0.5rem;align-items:flex-end;">
            <textarea id="chat-input"
                      rows="2"
                      placeholder="Введите сообщение…"
                      style="flex:1;resize:vertical;min-height:40px;max-height:120px;background:#020617;color:#e5e7eb;border:1px solid #374151;border-radius:0.375rem;padding:0.4rem 0.5rem;font-size:0.875rem;"></textarea>
            <button type="submit"
                    style="background:#2563eb;border:none;color:#e5e7eb;border-radius:0.375rem;padding:0.45rem 0.9rem;font-size:0.875rem;cursor:pointer;white-space:nowrap;">
                Отправить
            </button>
        </form>
        <div id="chat-status" style="margin-top:0.25rem;font-size:0.75rem;color:#9ca3af;"></div>
    </section>

    <section class="panel" id="agent-tools-panel" style="display:none;">
        <div class="panel-title">Доступ к MCP-инструментам</div>
        <div class="panel-subtitle">Управление разрешениями агентов на конкретные инструменты</div>
        <div id="agent-tools-content" style="font-size:0.85rem;color:#e5e7eb;">
            Загрузите агента, чтобы управлять доступом к инструментам.
        </div>
    </section>

    <section class="panel" id="fs-actions-panel" style="display:none;">
        <div class="panel-title">Filesystem MCP — быстрые действия</div>
        <div class="panel-subtitle">Архивы, JSON/YAML и другие операции доступны прямо из UI</div>

        <div id="fs-actions-helper" style="font-size:0.8rem;color:#9ca3af;margin-bottom:0.5rem;">
            Инструменты отображаются, если выбранный агент имеет доступ к Filesystem MCP.
        </div>

        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:0.75rem;">
            <div style="border:1px solid #1f2937;border-radius:0.5rem;padding:0.6rem;background:#020617;">
                <div style="font-weight:600;font-size:0.9rem;margin-bottom:0.3rem;">Создать ZIP</div>
                <form id="fs-zip-form">
                    <label style="display:block;font-size:0.75rem;color:#9ca3af;">Пути (по одному в строке)</label>
                    <textarea id="fs-zip-entries" rows="3" style="width:100%;margin-bottom:0.35rem;"></textarea>
                    <label style="display:block;font-size:0.75rem;color:#9ca3af;">Архив</label>
                    <input id="fs-zip-archive" type="text" style="width:100%;margin-bottom:0.35rem;">
                    <label style="font-size:0.75rem;color:#e5e7eb;">
                        <input type="checkbox" id="fs-zip-overwrite" checked> overwrite
                    </label>
                    <button type="submit"
                            style="margin-top:0.3rem;background:#2563eb;border:none;color:#e5e7eb;border-radius:0.375rem;padding:0.35rem 0.75rem;font-size:0.8rem;cursor:pointer;">
                        Создать
                    </button>
                </form>
            </div>

            <div style="border:1px solid #1f2937;border-radius:0.5rem;padding:0.6rem;background:#020617;">
                <div style="font-weight:600;font-size:0.9rem;margin-bottom:0.3rem;">Распаковать ZIP</div>
                <form id="fs-unzip-form">
                    <label style="display:block;font-size:0.75rem;color:#9ca3af;">Архив</label>
                    <input id="fs-unzip-archive" type="text" style="width:100%;margin-bottom:0.35rem;">
                    <label style="display:block;font-size:0.75rem;color:#9ca3af;">Каталог назначения</label>
                    <input id="fs-unzip-dest" type="text" style="width:100%;margin-bottom:0.35rem;">
                    <label style="font-size:0.75rem;color:#e5e7eb;">
                        <input type="checkbox" id="fs-unzip-overwrite" checked> overwrite
                    </label>
                    <button type="submit"
                            style="margin-top:0.3rem;background:#2563eb;border:none;color:#e5e7eb;border-radius:0.375rem;padding:0.35rem 0.75rem;font-size:0.8rem;cursor:pointer;">
                        Распаковать
                    </button>
                </form>
            </div>

            <div style="border:1px solid #1f2937;border-radius:0.5rem;padding:0.6rem;background:#020617;">
                <div style="font-weight:600;font-size:0.9rem;margin-bottom:0.3rem;">Прочитать JSON</div>
                <form id="fs-read-json-form">
                    <label style="display:block;font-size:0.75rem;color:#9ca3af;">Путь</label>
                    <input id="fs-json-read-path" type="text" style="width:100%;margin-bottom:0.35rem;">
                    <button type="submit"
                            style="margin-top:0.3rem;background:#2563eb;border:none;color:#e5e7eb;border-radius:0.375rem;padding:0.35rem 0.75rem;font-size:0.8rem;cursor:pointer;">
                        Прочитать
                    </button>
                </form>
                <pre id="fs-json-read-output" style="margin-top:0.4rem;font-size:0.75rem;color:#a5b4fc;white-space:pre-wrap;"></pre>
            </div>

            <div style="border:1px solid #1f2937;border-radius:0.5rem;padding:0.6rem;background:#020617;">
                <div style="font-weight:600;font-size:0.9rem;margin-bottom:0.3rem;">Записать JSON</div>
                <form id="fs-write-json-form">
                    <label style="display:block;font-size:0.75rem;color:#9ca3af;">Путь</label>
                    <input id="fs-json-write-path" type="text" style="width:100%;margin-bottom:0.35rem;">
                    <label style="display:block;font-size:0.75rem;color:#9ca3af;">JSON содержимое</label>
                    <textarea id="fs-json-write-data" rows="4" style="width:100%;margin-bottom:0.35rem;">{"example": true}</textarea>
                    <label style="font-size:0.75rem;color:#e5e7eb;">
                        <input type="checkbox" id="fs-json-write-overwrite" checked> overwrite
                    </label>
                    <button type="submit"
                            style="margin-top:0.3rem;background:#2563eb;border:none;color:#e5e7eb;border-radius:0.375rem;padding:0.35rem 0.75rem;font-size:0.8rem;cursor:pointer;">
                        Сохранить
                    </button>
                </form>
            </div>
        </div>

        <div id="fs-actions-log"
             style="margin-top:0.75rem;border:1px solid #1f2937;border-radius:0.5rem;padding:0.5rem;height:180px;overflow-y:auto;background:#020617;font-size:0.75rem;color:#e5e7eb;">
            <div style="color:#9ca3af;">Здесь появятся результаты инструментов Filesystem MCP.</div>
        </div>
    </section>

    <section class="panel scroll-y" id="side-panel">
        <div class="panel-title">MCP и пайплайны</div>
        <div class="panel-subtitle">Сервера, инструменты, пайплайны и память</div>

        <div style="margin-bottom:0.75rem;border-bottom:1px solid #1f2937;padding-bottom:0.5rem;">
            <div style="font-size:0.8rem;font-weight:600;margin-bottom:0.25rem;">LLM Registry</div>
            <div style="font-size:0.8rem;color:#9ca3af;">
                Primary chat model:
                <span style="color:#e5e7eb;">{{ llm_chat_primary|default:"—" }}</span>
            </div>
            <div style="font-size:0.8rem;color:#9ca3af;">
                Default embedding model:
                <span style="color:#e5e7eb;">{{ llm_embedding_default|default:"—" }}</span>
            </div>
            <button type="button" id="llm-sync-button"
                    style="margin-top:0.4rem;background:#374151;border:none;color:#e5e7eb;border-radius:0.375rem;padding:0.3rem 0.7rem;font-size:0.75rem;cursor:pointer;">
                Sync from OpenAI
            </button>
            <div id="llm-sync-status" style="margin-top:0.25rem;font-size:0.75rem;color:#9ca3af;"></div>
        </div>

        <div style="margin-bottom:0.75rem;">
            <div style="font-size:0.8rem;font-weight:600;margin-bottom:0.25rem;">MCP-серверы</div>
            <ul style="list-style:none;padding:0;margin:0;font-size:0.8rem;">
                {% for server in mcp_servers %}
                    <li style="margin-bottom:0.15rem;">
                        {{ server.name }}
                        {% if not server.is_active %}
                            <span style="color:#f97316;">· неактивен</span>
                        {% endif %}
                    </li>
                {% empty %}
                    <li style="color:#9ca3af;">Нет MCP-серверов</li>
                {% endfor %}
            </ul>
        </div>

        <div style="margin-bottom:0.75rem;">
            <div style="font-size:0.8rem;font-weight:600;margin-bottom:0.25rem;">Инструменты MCP</div>
            <ul style="list-style:none;padding:0;margin:0;font-size:0.8rem;">
                {% for tool in mcp_tools %}
                    <li style="margin-bottom:0.15rem;">
                        {{ tool.name }}
                        <span style="color:#6b7280;">· {{ tool.server.name }}</span>
                    </li>
                {% empty %}
                    <li style="color:#9ca3af;">Нет инструментов MCP</li>
                {% endfor %}
            </ul>
        </div>

        <div style="margin-bottom:0.75rem;">
            <div style="font-size:0.8rem;font-weight:600;margin-bottom:0.25rem;">Пайплайны</div>
            <ul style="list-style:none;padding:0;margin:0;font-size:0.8rem;">
                {% for pipeline in pipelines %}
                    <li style="margin-bottom:0.15rem;">
                        {{ pipeline.name }}
                        <span style="color:#6b7280;">· {{ pipeline.owner_agent.name }}</span>
                    </li>
                {% empty %}
                    <li style="color:#9ca3af;">Нет пайплайнов для проекта</li>
                {% endfor %}
            </ul>
        </div>

        <div>
            <div style="font-size:0.8rem;font-weight:600;margin-bottom:0.25rem;">Память (последние события)</div>
            <ul style="list-style:none;padding:0;margin:0;font-size:0.8rem;">
                {% for event in memory_events %}
                    <li style="margin-bottom:0.25rem;">
                        <span style="color:#9ca3af;">{{ event.get_type_display }}:</span>
                        {{ event.content|truncatechars:80 }}
                    </li>
                {% empty %}
                    <li style="color:#9ca3af;">Пока нет событий памяти</li>
                {% endfor %}
            </ul>
        </div>
    </section>
{% endblock %}

{% block extra_js %}
<script>
    (function () {
        const projectSelect = document.getElementById("project-select");
        const agentsPanel = document.getElementById("agents-panel");
        const agentsList = document.getElementById("agents-list");
        const chatForm = document.getElementById("chat-form");
        const chatInput = document.getElementById("chat-input");
        const chatMessages = document.getElementById("chat-messages");
        const chatStatus = document.getElementById("chat-status");
        const agentToolsPanelEl = document.getElementById("agent-tools-panel");
        const agentToolsContentEl = document.getElementById("agent-tools-content");
        const fsActionsPanel = document.getElementById("fs-actions-panel");
        const fsActionsLog = document.getElementById("fs-actions-log");
        const fsZipForm = document.getElementById("fs-zip-form");
        const fsUnzipForm = document.getElementById("fs-unzip-form");
        const fsReadJsonForm = document.getElementById("fs-read-json-form");
        const fsWriteJsonForm = document.getElementById("fs-write-json-form");
        const fsJsonReadOutput = document.getElementById("fs-json-read-output");

        const agentDetails = document.getElementById("agent-details");
        const agentDetailsName = document.getElementById("agent-details-name");
        const agentDetailsResolved = document.getElementById("agent-details-resolved");
        const agentDetailsBadge = document.getElementById("agent-details-badge");
        const agentDetailsStatus = document.getElementById("agent-details-status");
        const agentWarningBanner = document.getElementById("agent-warning-banner");
        const llmSyncButton = document.getElementById("llm-sync-button");
        const llmSyncStatus = document.getElementById("llm-sync-status");
        const agentModelSelect = document.getElementById("agent-model-select");
        const agentModelSave = document.getElementById("agent-model-save");

        function getCookie(name) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${name}=`);
            if (parts.length === 2) return parts.pop().split(";").shift();
        }

        function scrollChatToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        async function loadModelsRegistry() {
            try {
                const resp = await fetch("/api/models/registry/");
                if (!resp.ok) return null;
                return await resp.json();
            } catch (e) {
                console.error("Failed to load models registry", e);
                return null;
            }
        }

        if (llmSyncButton) {
            llmSyncButton.addEventListener("click", async () => {
                llmSyncButton.disabled = true;
                if (llmSyncStatus) {
                    llmSyncStatus.textContent = "Запускаю синхронизацию реестра моделей…";
                }
                try {
                    const resp = await fetch("/api/models/registry/sync/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken") || "",
                        },
                    });
                    if (!resp.ok) {
                        const txt = await resp.text();
                        throw new Error(txt || "Ошибка запуска синхронизации");
                    }
                    if (llmSyncStatus) {
                        llmSyncStatus.textContent = "Синхронизация запланирована.";
                    }
                    // сбросим локальный кэш реестра
                    cachedRegistry = null;
                } catch (e) {
                    console.error(e);
                    if (llmSyncStatus) {
                        llmSyncStatus.textContent = "Не удалось запланировать синхронизацию.";
                    }
                } finally {
                    llmSyncButton.disabled = false;
                }
            });
        }

        // --- Project selection with localStorage + query param ---
        if (projectSelect) {
            const urlParams = new URLSearchParams(window.location.search);
            const urlProject = urlParams.get("project");
            const storedProject = window.localStorage.getItem("current_project_id");

            if (!urlProject && storedProject) {
                const option = Array.from(projectSelect.options).find(o => o.value === storedProject);
                if (option) {
                    urlParams.set("project", storedProject);
                    window.location.search = urlParams.toString();
                }
            }

            projectSelect.addEventListener("change", () => {
                const value = projectSelect.value;
                if (value) {
                    window.localStorage.setItem("current_project_id", value);
                    const params = new URLSearchParams(window.location.search);
                    params.set("project", value);
                    window.location.search = params.toString();
                }
            });
        }

        let currentAgentId = agentsPanel ? agentsPanel.dataset.initialAgentId || null : null;
        let currentConversationId = null;
        let filesystemToolMap = {};
        let fsFormsInitialized = false;

        let cachedRegistry = null;

        function resetAgentToolPanels() {
            filesystemToolMap = {};
            if (agentToolsPanelEl && agentToolsContentEl) {
                agentToolsPanelEl.style.display = "none";
                agentToolsContentEl.innerHTML = "Загрузите агента, чтобы увидеть доступные инструменты.";
            }
            if (fsActionsPanel) {
                fsActionsPanel.style.display = "none";
            }
        }

        resetAgentToolPanels();

        function pushFsLog(title, payload, isError = false) {
            if (!fsActionsLog) return;
            const wrapper = document.createElement("div");
            wrapper.style.marginBottom = "0.5rem";
            const header = document.createElement("div");
            header.style.fontSize = "0.8rem";
            header.style.fontWeight = "600";
            header.style.color = isError ? "#fca5a5" : "#a5b4fc";
            header.textContent = title;
            const pre = document.createElement("pre");
            pre.style.whiteSpace = "pre-wrap";
            pre.style.fontSize = "0.75rem";
            pre.style.marginTop = "0.2rem";
            pre.textContent =
                typeof payload === "string" ? payload : JSON.stringify(payload, null, 2);
            wrapper.appendChild(header);
            wrapper.appendChild(pre);
            fsActionsLog.prepend(wrapper);
        }

        async function invokeFilesystemTool(toolName, args) {
            const toolId = filesystemToolMap[toolName];
            if (!toolId) {
                throw new Error(`Инструмент ${toolName} недоступен для текущего агента.`);
            }
            const resp = await fetch(`/api/mcp/tools/${toolId}/invoke/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken") || "",
                },
                body: JSON.stringify({ arguments: args }),
            });
            const data = await resp.json();
            if (!resp.ok || data.error) {
                throw new Error(data.error?.message || "Ошибка вызова инструмента");
            }
            const result =
                data.result?.structuredContent?.result ||
                data.result?.structuredContent ||
                data.result ||
                data;
            return result;
        }

        function initFsActionForms() {
            if (fsFormsInitialized) return;
            fsFormsInitialized = true;

            if (fsZipForm) {
                fsZipForm.addEventListener("submit", async (event) => {
                    event.preventDefault();
                    const entriesField = document.getElementById("fs-zip-entries");
                    const archiveField = document.getElementById("fs-zip-archive");
                    const overwriteField = document.getElementById("fs-zip-overwrite");
                    try {
                        const entries = (entriesField.value || "")
                            .split("\n")
                            .map((v) => v.trim())
                            .filter(Boolean);
                        if (!entries.length) {
                            throw new Error("Укажите хотя бы один путь для архивации.");
                        }
                        const archive = archiveField.value.trim();
                        if (!archive) {
                            throw new Error("Введите путь для архива.");
                        }
                        const result = await invokeFilesystemTool("fs_zip", {
                            entries,
                            archive_path: archive,
                            overwrite: !!overwriteField.checked,
                        });
                        pushFsLog("fs_zip", result);
                    } catch (err) {
                        pushFsLog("fs_zip — ошибка", err.message || err, true);
                    }
                });
            }

            if (fsUnzipForm) {
                fsUnzipForm.addEventListener("submit", async (event) => {
                    event.preventDefault();
                    const archiveField = document.getElementById("fs-unzip-archive");
                    const destField = document.getElementById("fs-unzip-dest");
                    const overwriteField = document.getElementById("fs-unzip-overwrite");
                    try {
                        const archive = archiveField.value.trim();
                        const dest = destField.value.trim();
                        if (!archive || !dest) {
                            throw new Error("Укажите и архив, и каталог назначения.");
                        }
                        const result = await invokeFilesystemTool("fs_unzip", {
                            archive_path: archive,
                            dest_path: dest,
                            overwrite: !!overwriteField.checked,
                        });
                        pushFsLog("fs_unzip", result);
                    } catch (err) {
                        pushFsLog("fs_unzip — ошибка", err.message || err, true);
                    }
                });
            }

            if (fsReadJsonForm) {
                fsReadJsonForm.addEventListener("submit", async (event) => {
                    event.preventDefault();
                    const pathField = document.getElementById("fs-json-read-path");
                    try {
                        const path = pathField.value.trim();
                        if (!path) throw new Error("Укажите путь к файлу.");
                        const result = await invokeFilesystemTool("fs_read_json", { path });
                        if (fsJsonReadOutput) {
                            fsJsonReadOutput.textContent = JSON.stringify(result.data, null, 2);
                        }
                        pushFsLog("fs_read_json", result);
                    } catch (err) {
                        if (fsJsonReadOutput) fsJsonReadOutput.textContent = "";
                        pushFsLog("fs_read_json — ошибка", err.message || err, true);
                    }
                });
            }

            if (fsWriteJsonForm) {
                fsWriteJsonForm.addEventListener("submit", async (event) => {
                    event.preventDefault();
                    const pathField = document.getElementById("fs-json-write-path");
                    const dataField = document.getElementById("fs-json-write-data");
                    const overwriteField = document.getElementById("fs-json-write-overwrite");
                    try {
                        const path = pathField.value.trim();
                        if (!path) throw new Error("Укажите путь для записи.");
                        let parsed;
                        try {
                            parsed = JSON.parse(dataField.value);
                        } catch (jsonErr) {
                            throw new Error("Некорректный JSON: " + jsonErr.message);
                        }
                        const result = await invokeFilesystemTool("fs_write_json", {
                            path,
                            data: parsed,
                            overwrite: !!overwriteField.checked,
                        });
                        pushFsLog("fs_write_json", result);
                    } catch (err) {
                        pushFsLog("fs_write_json — ошибка", err.message || err, true);
                    }
                });
            }
        }

        initFsActionForms();

        async function ensureRegistryLoaded() {
            if (cachedRegistry) return cachedRegistry;
            cachedRegistry = await loadModelsRegistry();
            return cachedRegistry;
        }

        async function loadAgentDetails(agentId) {
            if (!agentId) {
                resetAgentToolPanels();
                return;
            }
            resetAgentToolPanels();
            try {
                const resp = await fetch(`/api/agents/${agentId}/`);
                if (!resp.ok) throw new Error("Failed to load agent");
                const agent = await resp.json();
                const registry = await ensureRegistryLoaded();

                if (agentDetails) {
                    agentDetails.style.display = "block";
                    agentDetailsName.textContent = agent.name || `Agent #${agent.id}`;
                    agentDetailsResolved.textContent = agent.resolved_model_name || "—";

                    if (!agent.model_name) {
                        agentDetailsBadge.textContent = "(по умолчанию из реестра)";
                    } else {
                        agentDetailsBadge.textContent = "(переопределена вручную)";
                    }

                    if (agentWarningBanner) {
                        if (agent.warning) {
                            agentWarningBanner.style.display = "block";
                            agentWarningBanner.textContent = agent.warning;
                        } else {
                            agentWarningBanner.style.display = "none";
                            agentWarningBanner.textContent = "";
                        }
                    }

                    agentDetailsStatus.textContent = "";

                    if (registry && agentModelSelect) {
                        const primary = registry.chat_primary;
                        const recommended = registry.chat_recommended || [];
                        const allChat = registry.chat || [];
                        const deprecated = registry.deprecated || [];

                        const currentExplicit = agent.model_name || "";

                        while (agentModelSelect.firstChild) {
                            agentModelSelect.removeChild(agentModelSelect.firstChild);
                        }

                        const optDefault = document.createElement("option");
                        optDefault.value = "";
                        optDefault.textContent = primary
                            ? `Использовать default (${primary})`
                            : "Использовать default (chat.primary)";
                        agentModelSelect.appendChild(optDefault);

                        if (recommended.length) {
                            const groupLabel = document.createElement("option");
                            groupLabel.disabled = true;
                            groupLabel.textContent = "— Рекомендуемые —";
                            agentModelSelect.appendChild(groupLabel);

                            recommended.forEach(name => {
                                const opt = document.createElement("option");
                                opt.value = name;
                                opt.textContent = name === primary ? `${name} (primary)` : name;
                                agentModelSelect.appendChild(opt);
                            });
                        }

                        const other = allChat.filter(
                            name => !recommended.includes(name)
                        );
                        if (other.length) {
                            const groupLabel2 = document.createElement("option");
                            groupLabel2.disabled = true;
                            groupLabel2.textContent = "— Другие chat-модели —";
                            agentModelSelect.appendChild(groupLabel2);
                            other.forEach(name => {
                                const opt = document.createElement("option");
                                opt.value = name;
                                opt.textContent = name;
                                agentModelSelect.appendChild(opt);
                            });
                        }

                        const deprecatedList = deprecated.filter(name => allChat.includes(name));
                        if (deprecatedList.length) {
                            const groupLabel3 = document.createElement("option");
                            groupLabel3.disabled = true;
                            groupLabel3.textContent = "— Устаревшие (не рекомендуется) —";
                            agentModelSelect.appendChild(groupLabel3);
                            deprecatedList.forEach(name => {
                                const opt = document.createElement("option");
                                opt.value = name;
                                opt.textContent = name + " (deprecated)";
                                agentModelSelect.appendChild(opt);
                            });
                        }

                        // Выбор текущего значения
                        agentModelSelect.value = currentExplicit;
                    }
                }
                loadAgentMcpAccess(agent.id);
            } catch (e) {
                console.error(e);
                if (agentDetailsStatus) {
                    agentDetailsStatus.textContent = "Не удалось загрузить данные агента.";
                }
                resetAgentToolPanels();
            }
        }

        async function loadAgentMcpAccess(agentId) {
            if (!agentToolsPanelEl || !agentToolsContentEl) return;
            agentToolsPanelEl.style.display = "block";
            agentToolsContentEl.textContent = "Загрузка...";
            filesystemToolMap = {};
            if (fsActionsPanel) {
                fsActionsPanel.style.display = "none";
            }
            try {
                const resp = await fetch(`/api/agents/${agentId}/mcp-access/`);
                if (!resp.ok) {
                    const txt = await resp.text();
                    throw new Error(txt || "Не удалось получить доступы.");
                }
                const data = await resp.json();
                renderAgentMcpAccess(data);
            } catch (err) {
                console.error(err);
                agentToolsContentEl.innerHTML =
                    `<div style="color:#fca5a5;">${err.message || err}</div>`;
                if (fsActionsPanel) {
                    fsActionsPanel.style.display = "none";
                }
            }
        }

        function renderAgentMcpAccess(payload) {
            if (!agentToolsPanelEl || !agentToolsContentEl) return;
            const bindings = payload.bindings || [];
            if (!bindings.length) {
                agentToolsContentEl.innerHTML =
                    "<div style='color:#9ca3af;'>У агента нет привязанных MCP-серверов.</div>";
                agentToolsPanelEl.style.display = "block";
                if (fsActionsPanel) fsActionsPanel.style.display = "none";
                filesystemToolMap = {};
                return;
            }
            agentToolsPanelEl.style.display = "block";
            agentToolsContentEl.innerHTML = "";

            let hasFilesystem = false;

            bindings.forEach((binding, index) => {
                const container = document.createElement("div");
                container.style.border = "1px solid #1f2937";
                container.style.borderRadius = "0.5rem";
                container.style.padding = "0.6rem";
                container.style.background = "#020617";
                container.style.marginBottom = "0.6rem";

                const title = document.createElement("div");
                title.style.fontWeight = "600";
                title.style.marginBottom = "0.35rem";
                title.textContent = `Сервер: ${binding.server.name}`;
                container.appendChild(title);

                const allowAllWrapper = document.createElement("label");
                allowAllWrapper.style.display = "flex";
                allowAllWrapper.style.alignItems = "center";
                allowAllWrapper.style.gap = "0.35rem";
                allowAllWrapper.style.fontSize = "0.75rem";
                allowAllWrapper.style.color = "#e5e7eb";
                const allowAllInput = document.createElement("input");
                allowAllInput.type = "checkbox";
                allowAllInput.checked = !!binding.all_allowed;
                allowAllWrapper.appendChild(allowAllInput);
                allowAllWrapper.appendChild(
                    document.createTextNode("Все инструменты (без ограничений)")
                );
                container.appendChild(allowAllWrapper);

                const list = document.createElement("div");
                list.style.display = "grid";
                list.style.gridTemplateColumns = "repeat(auto-fit, minmax(140px, 1fr))";
                list.style.gap = "0.25rem";
                list.style.margin = "0.5rem 0";

                const toolCheckboxes = [];
                (binding.tools || []).forEach((tool) => {
                    const item = document.createElement("label");
                    item.style.display = "flex";
                    item.style.alignItems = "center";
                    item.style.gap = "0.35rem";
                    item.style.fontSize = "0.75rem";
                    item.style.color = "#e5e7eb";
                    const checkbox = document.createElement("input");
                    checkbox.type = "checkbox";
                    checkbox.value = tool.id;
                    checkbox.checked =
                        binding.all_allowed ||
                        (binding.allowed_tool_ids || []).includes(tool.id);
                    item.appendChild(checkbox);
                    item.appendChild(document.createTextNode(tool.name));
                    if (tool.description) {
                        item.title = tool.description;
                    }
                    list.appendChild(item);
                    toolCheckboxes.push(checkbox);
                });

                container.appendChild(list);

                const buttonsRow = document.createElement("div");
                buttonsRow.style.display = "flex";
                buttonsRow.style.alignItems = "center";
                buttonsRow.style.gap = "0.5rem";

                const saveBtn = document.createElement("button");
                saveBtn.textContent = "Сохранить доступ";
                saveBtn.style.background = "#2563eb";
                saveBtn.style.border = "none";
                saveBtn.style.color = "#e5e7eb";
                saveBtn.style.borderRadius = "0.375rem";
                saveBtn.style.padding = "0.35rem 0.7rem";
                saveBtn.style.fontSize = "0.8rem";
                saveBtn.style.cursor = "pointer";

                const status = document.createElement("div");
                status.style.fontSize = "0.75rem";
                status.style.color = "#9ca3af";

                buttonsRow.appendChild(saveBtn);
                buttonsRow.appendChild(status);
                container.appendChild(buttonsRow);

                const updateCheckboxState = () => {
                    const disabled = allowAllInput.checked;
                    toolCheckboxes.forEach((box) => {
                        box.disabled = disabled;
                    });
                };
                updateCheckboxState();
                allowAllInput.addEventListener("change", updateCheckboxState);

                saveBtn.addEventListener("click", async () => {
                    status.textContent = "Сохранение…";
                    saveBtn.disabled = true;
                    try {
                        const payload = {
                            server_id: binding.server.id,
                            allowed_tool_ids: allowAllInput.checked
                                ? []
                                : toolCheckboxes.filter((box) => box.checked).map((box) => Number(box.value)),
                        };
                        const resp = await fetch(`/api/agents/${currentAgentId}/mcp-access/`, {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": getCookie("csrftoken") || "",
                            },
                            body: JSON.stringify(payload),
                        });
                        if (!resp.ok) {
                            const txt = await resp.text();
                            throw new Error(txt || "Не удалось сохранить");
                        }
                        status.textContent = "Сохранено";
                        if (currentAgentId) {
                            loadAgentMcpAccess(currentAgentId);
                        }
                    } catch (err) {
                        status.textContent = err.message || "Ошибка";
                    } finally {
                        saveBtn.disabled = false;
                    }
                });

                agentToolsContentEl.appendChild(container);

                if (binding.server.name.toLowerCase().includes("filesystem")) {
                    hasFilesystem = true;
                    filesystemToolMap = {};
                    (binding.tools || []).forEach((tool) => {
                        filesystemToolMap[tool.name] = tool.id;
                    });
                }
            });

            if (fsActionsPanel) {
                fsActionsPanel.style.display = hasFilesystem ? "block" : "none";
            }
        }

        function updateAgentsSelection() {
            const buttons = agentsList ? agentsList.querySelectorAll(".agent-item") : [];
            buttons.forEach(btn => {
                const agentId = btn.dataset.agentId;
                if (currentAgentId && agentId === String(currentAgentId)) {
                    btn.style.borderColor = "#2563eb";
                    btn.style.backgroundColor = "#020617";
                } else {
                    btn.style.borderColor = "#1f2937";
                    btn.style.backgroundColor = "#020617";
                }
            });
        }

        if (agentsList) {
            agentsList.addEventListener("click", (event) => {
                const button = event.target.closest(".agent-item");
                if (!button) return;
                currentAgentId = button.dataset.agentId;
                currentConversationId = null;
                chatMessages.innerHTML = "";
                chatStatus.textContent = "Новый диалог с агентом: " + button.textContent.trim();
                updateAgentsSelection();
                resetAgentToolPanels();
                loadAgentDetails(currentAgentId);
            });
            if (!currentAgentId) {
                const primary = agentsList.querySelector('.agent-item[data-is-primary="1"]');
                const first = agentsList.querySelector(".agent-item");
                const initial = primary || first;
                if (initial) {
                    currentAgentId = initial.dataset.agentId;
                }
            }
            updateAgentsSelection();
            if (currentAgentId) {
                loadAgentDetails(currentAgentId);
            }
        }

        if (agentModelSave) {
            agentModelSave.addEventListener("click", async () => {
                if (!currentAgentId) return;
                const selected = agentModelSelect ? agentModelSelect.value : "";
                agentModelSave.disabled = true;
                agentDetailsStatus.textContent = "Сохранение…";
                try {
                    const resp = await fetch(`/api/agents/${currentAgentId}/`, {
                        method: "PATCH",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCookie("csrftoken") || "",
                        },
                        body: JSON.stringify({ model_name: selected }),
                    });
                    if (!resp.ok) {
                        const txt = await resp.text();
                        throw new Error(txt || "Ошибка сохранения агента");
                    }
                    const updated = await resp.json();
                    agentDetailsResolved.textContent = updated.resolved_model_name || "—";
                    if (!updated.model_name) {
                        agentDetailsBadge.textContent = "(по умолчанию из реестра)";
                    } else {
                        agentDetailsBadge.textContent = "(переопределена вручную)";
                    }
                    agentDetailsStatus.textContent = "Сохранено.";
                } catch (e) {
                    console.error(e);
                    agentDetailsStatus.textContent = "Ошибка сохранения модели агента.";
                } finally {
                    agentModelSave.disabled = false;
                }
            });
        }

        function appendMessages(messages) {
            messages.forEach(msg => {
                const wrapper = document.createElement("div");
                wrapper.style.marginBottom = "0.4rem";
                const sender = msg.sender === "user" ? "Вы" :
                    (msg.sender === "assistant" ? "Ассистент" : "Система");
                const color = msg.sender === "user" ? "#bfdbfe" :
                    (msg.sender === "assistant" ? "#bbf7d0" : "#e5e7eb");
                const bubble = document.createElement("div");
                bubble.innerHTML = `<div style="font-size:0.75rem;color:#9ca3af;margin-bottom:0.1rem;">${sender}</div>
                                     <div style="padding:0.35rem 0.5rem;border-radius:0.375rem;background:#020617;border:1px solid #1f2937;color:${color};white-space:pre-wrap;">${msg.content}</div>`;
                wrapper.appendChild(bubble);

                const traces = Array.isArray(msg.meta?.tool_traces) ? msg.meta.tool_traces : [];
                if (traces.length) {
                    const traceBox = document.createElement("div");
                    traceBox.style.marginTop = "0.25rem";
                    traceBox.style.fontSize = "0.7rem";
                    traceBox.style.color = "#a1a1aa";
                    traceBox.style.border = "1px solid #1f2937";
                    traceBox.style.borderRadius = "0.375rem";
                    traceBox.style.background = "#0f172a";
                    traceBox.style.padding = "0.35rem 0.5rem";
                    traceBox.innerHTML = "<strong>tool_traces</strong>";

                    traces.forEach(trace => {
                        const item = document.createElement("div");
                        item.style.marginTop = "0.2rem";
                        const payload = trace.payload ? JSON.stringify(trace.payload, null, 2) : "";
                        item.innerHTML = `
                            <div>• ${trace.function || "tool"} (${trace.tool_call_id || "n/a"})</div>
                            <pre style="white-space:pre-wrap;margin:0.1rem 0 0;">${payload}</pre>
                        `;
                        traceBox.appendChild(item);
                    });

                    wrapper.appendChild(traceBox);
                }
                chatMessages.appendChild(wrapper);
            });
            scrollChatToBottom();
        }

        async function sendAssistantMessage(projectId, agentId, text, conversationId) {
            const payload = {
                message: text,
                agent_id: Number(agentId),
            };
            if (conversationId) {
                payload.conversation_id = conversationId;
            }

            const response = await fetch(`/api/projects/${projectId}/assistant/chat/`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCookie("csrftoken") || "",
                },
                body: JSON.stringify(payload),
            });
            if (!response.ok) {
                const textErr = await response.text();
                throw new Error(textErr || "Ошибка ответа сервера");
            }
            return response.json();
        }

        if (chatForm) {
            chatForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                const text = chatInput.value.trim();
                if (!text) return;
                const projectId = agentsPanel ? agentsPanel.dataset.currentProjectId : null;
                if (!projectId) {
                    chatStatus.textContent = "Проект не выбран.";
                    return;
                }
                if (!currentAgentId) {
                    chatStatus.textContent = "Нет выбранного агента.";
                    return;
                }

                chatForm.querySelector("button[type=submit]").disabled = true;
                chatStatus.textContent = "Отправка...";

                try {
                    const data = await sendAssistantMessage(
                        projectId,
                        currentAgentId,
                        text,
                        currentConversationId,
                    );
                    currentConversationId = data.conversation_id;
                    appendMessages(data.messages || []);
                    chatInput.value = "";
                    chatStatus.textContent = "";
                } catch (err) {
                    console.error(err);
                    chatStatus.textContent = "Ошибка: " + (err.message || err);
                } finally {
                    chatForm.querySelector("button[type=submit]").disabled = false;
                }
            });
        }
    })();
</script>
{% endblock %}
