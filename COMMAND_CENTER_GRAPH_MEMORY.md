–û–∫, —Å–¥–µ–ª–∞–µ–º —Å—Ä–∞–∑—É **–ø–æ–ª–Ω—ã–π —Å–ø—Ä–∏–Ω—Ç Graph Memory v1** –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π –º–æ–∂–Ω–æ —Å—Ä–∞–∑—É –æ—Ç–¥–∞–≤–∞—Ç—å –ø–æ–º–æ—â–Ω–∏–∫—É / –∞–≥–µ–Ω—Ç–∞–º.

–ù–∏–∂–µ ‚Äî —Ü–µ–ª—å, —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –∏ –ø–æ–¥—Ä–æ–±–Ω—ã–µ –∑–∞–¥–∞—á–∏ –ø–æ –¥–Ω—è–º.
–ï—Å–ª–∏ –∑–∞—Ö–æ—á–µ—à—å ‚Äî –ø–æ—Ç–æ–º –º–æ–∂–Ω–æ –≤—ã–Ω–µ—Å—Ç–∏ —ç—Ç–æ –≤ `.md` –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.

---

# üß† –°–ø—Ä–∏–Ω—Ç: Graph Memory v1 –¥–ª—è Command Center

## üéØ –¶–µ–ª—å —Å–ø—Ä–∏–Ω—Ç–∞

–î–æ–±–∞–≤–∏—Ç—å –ø–æ–≤–µ—Ä—Ö —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–π long-term –ø–∞–º—è—Ç–∏ –∞–≥–µ–Ω—Ç–æ–≤ (MemoryEvent + AgentMemory) **–≥—Ä–∞—Ñ –∑–Ω–∞–Ω–∏–π**:

* —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞—Ç—å **—Å—É—â–Ω–æ—Å—Ç–∏** (—É–∑–ª—ã) –∏ **—Å–≤—è–∑–∏** (—Ä—ë–±—Ä–∞) –º–µ–∂–¥—É –Ω–∏–º–∏;
* –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏–∑–≤–ª–µ–∫–∞—Ç—å –≥—Ä–∞—Ñ–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∏–∑ MemoryEvent;
* –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ –ø—Ä–∏ –æ—Ç–≤–µ—Ç–∞—Ö –∞–≥–µ–Ω—Ç–æ–≤ (AGENT GRAPH MEMORY);
* –¥–∞—Ç—å –º–∏–Ω–∏–º—É–º UI/API –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∞.

Graph Memory v1 ‚Äî —ç—Ç–æ **–Ω–∞–¥—Å—Ç—Ä–æ–π–∫–∞**, –Ω–µ –∑–∞–º–µ–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ memory-—Å–ª–æ—è.

---

## üìÜ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–ø—Ä–∏–Ω—Ç–∞

* **Day 1 ‚Äî –ú–æ–¥–µ–ª–∏ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏ (KnowledgeNode / KnowledgeEdge).**
* **Day 2 ‚Äî Graph Extractor (LLM ‚Üí nodes/edges).**
* **Day 3 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Graph Extractor –≤ Memory pipeline.**
* **Day 4 ‚Äî Graph Retrieval + AGENT GRAPH MEMORY.**
* **Day 5 ‚Äî UI / API –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∞.**
* **Day 6 ‚Äî –¢–µ—Å—Ç—ã –∏ –±–∞–∑–æ–≤–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞.**
* **Day 7 ‚Äî –ù–∞—Å—Ç—Ä–æ–π–∫–∞ retention –∏ –ª–∏–º–∏—Ç–æ–≤ –¥–ª—è –≥—Ä–∞—Ñ–∞.**

---

## üß© Day 1 ‚Äî –ú–æ–¥–µ–ª–∏ –∏ –º–∏–≥—Ä–∞—Ü–∏–∏

### –ó–∞–¥–∞—á–∞ 1. –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª–∏ `KnowledgeNode` –∏ `KnowledgeEdge`

**–§–∞–π–ª:** `core/models.py`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ `KnowledgeNode`:**

* –ø–æ–ª—è:

  * `id` ‚Äî UUID primary key
  * `agent` ‚Äî FK –Ω–∞ Agent (–∫–∞–∂–¥—ã–π —É–∑–µ–ª –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –∞–≥–µ–Ω—Ç—É)
  * `label` ‚Äî –∫—Ä–∞—Ç–∫–æ–µ –∏–º—è —É–∑–ª–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, `"Command Center"`, `"filesystem MCP"`, `"Property: –í–∏–Ω–æ–≥—Ä–∞–¥–Ω–∞—è 10"`)
  * `type` ‚Äî —Ç–∏–ø —Å—É—â–Ω–æ—Å—Ç–∏ (`"service"`, `"mcp_server"`, `"crm_model"`, `"scenario"`, `"property"`, `"docker_service"` –∏ —Ç.–ø.)
  * `description` ‚Äî —á–µ–ª–æ–≤–µ–∫–æ—á–∏—Ç–∞–µ–º–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ
  * `embedding` ‚Äî `VectorField(dimensions=1536, null=True, blank=True)`
  * `object_type` ‚Äî —Å—Ç—Ä–æ–∫–∞, –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è –ø—Ä–∏–≤—è–∑–∫–∞ –∫ —Ä–µ–∞–ª—å–Ω–æ–π –º–æ–¥–µ–ª–∏ (`"Property"`, `"Agent"`, `"DockerService"`, `"McpServer"`)
  * `object_id` ‚Äî —Å—Ç—Ä–æ–∫–∞ –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–∞ –æ–±—ä–µ–∫—Ç–∞ (`"123"`, `"web"`, `"filesystem"`)
  * `created_at`, `updated_at`
* `unique_together = ("agent", "label", "type")`

**–¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ `KnowledgeEdge`:**

* –ø–æ–ª—è:

  * `id` ‚Äî UUID primary key
  * `agent` ‚Äî FK –Ω–∞ Agent
  * `source` ‚Äî FK –Ω–∞ KnowledgeNode
  * `target` ‚Äî FK –Ω–∞ KnowledgeNode
  * `relation` ‚Äî —Å—Ç—Ä–æ–∫–∞ (`"uses"`, `"depends_on"`, `"part_of"`, `"deployed_on"`, `"related_to"`, `"manages"`, ‚Ä¶)
  * `description` ‚Äî —Ç–µ–∫—Å—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
  * `weight` ‚Äî float (0‚Äì1, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 1.0)
  * `created_at`
* `__str__` –≤–∏–¥–∞ `"{source} -[{relation}]-> {target}"`

---

### –ó–∞–¥–∞—á–∞ 2. –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª–∏ –≤ –∞–¥–º–∏–Ω–∫–µ

**–§–∞–π–ª:** `core/admin.py`

* `KnowledgeNodeAdmin`:

  * `list_display = ("id", "agent", "label", "type", "object_type", "object_id", "created_at")`
  * `list_filter = ("agent", "type", "object_type")`
  * `search_fields = ("label", "description", "object_type", "object_id")`
* `KnowledgeEdgeAdmin`:

  * `list_display = ("id", "agent", "source", "relation", "target", "weight", "created_at")`
  * `list_filter = ("agent", "relation")`
  * `search_fields = ("source__label", "target__label", "relation", "description")`

---

### –ó–∞–¥–∞—á–∞ 3. –ú–∏–≥—Ä–∞—Ü–∏–∏

* `docker-compose exec web python manage.py makemigrations core`
* `docker-compose exec web python manage.py migrate core`
* –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤ –∞–¥–º–∏–Ω–∫–µ:

  * –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å `KnowledgeNode` –≤—Ä—É—á–Ω—É—é,
  * –º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å `KnowledgeEdge` –º–µ–∂–¥—É –Ω–æ–¥–∞–º–∏.

---

## üß© Day 2 ‚Äî Graph Extractor (LLM ‚Üí nodes/edges)

–¶–µ–ª—å: —Å–¥–µ–ª–∞—Ç—å —Å–µ—Ä–≤–∏—Å, –∫–æ—Ç–æ—Ä—ã–π –∏–∑ —Ç–µ–∫—Å—Ç–∞ `MemoryEvent.content` –∏–∑–≤–ª–µ–∫–∞–µ—Ç **—É–∑–ª—ã –∏ —Å–≤—è–∑–∏**.

### –ó–∞–¥–∞—á–∞ 1. –°–æ–∑–¥–∞—Ç—å –º–æ–¥—É–ª—å `core/graph_extractor.py`

**–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è:**

```python
def extract_graph_from_text(agent: Agent, text: str) -> dict:
    """
    –í—ã–∑—ã–≤–∞–µ—Ç LLM —Å –ø—Ä–æ–º–ø—Ç–æ–º Graph Extractor.
    –û–∂–∏–¥–∞–µ—Ç JSON:
    {
      "nodes": [
        {"label": "...", "type": "...", "description": "..."},
        ...
      ],
      "edges": [
        {"source_label": "...", "target_label": "...", "relation": "...", "description": "..."},
        ...
      ]
    }
    –°–æ–∑–¥–∞—ë—Ç/–æ–±–Ω–æ–≤–ª—è–µ—Ç KnowledgeNode/KnowledgeEdge.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç dict —Å –∫—Ä–∞—Ç–∫–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π: {"created_nodes": N, "created_edges": M}
    """
```

### –ó–∞–¥–∞—á–∞ 2. System prompt –¥–ª—è Graph Extractor

–ü—Ä–∏–º–µ—Ä (–¥–æ–±–∞–≤–∏—Ç—å –≤ –º–æ–¥—É–ª—å –∫–∞–∫ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É):

```text
–¢—ã ‚Äî Graph Memory Extractor –≤ —Å–∏—Å—Ç–µ–º–µ Sochi.Rent Command Center.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞:
- —á–∏—Ç–∞—Ç—å —Ç–µ–∫—Å—Ç (—Ñ–∞–∫—Ç, —Å–æ–±—ã—Ç–∏–µ, –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –¥–æ–≥–æ–≤–æ—Ä—ë–Ω–Ω–æ—Å—Ç—å);
- –≤—ã–¥–µ–ª—è—Ç—å –∏–∑ –Ω–µ–≥–æ –≤–∞–∂–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏ (—É–∑–ª—ã –≥—Ä–∞—Ñ–∞);
- —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—Ç—å —Å–≤—è–∑–∏ –º–µ–∂–¥—É —ç—Ç–∏–º–∏ —Å—É—â–Ω–æ—Å—Ç—è–º–∏.

–°—É—â–Ω–æ—Å—Ç–∏ (nodes) ‚Äî —ç—Ç–æ –æ–±—ä–µ–∫—Ç—ã —Ç–∏–ø–∞:
- —Å–µ—Ä–≤–∏—Å—ã (CRM, Command Center, Make-—Å—Ü–µ–Ω–∞—Ä–∏–∏, MCP-—Å–µ—Ä–≤–µ—Ä—ã, Docker-—Å–µ—Ä–≤–∏—Å—ã)
- –±–∏–∑–Ω–µ—Å-—Å—É—â–Ω–æ—Å—Ç–∏ (–æ–±—ä–µ–∫—Ç—ã –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏, –≤–ª–∞–¥–µ–ª—å—Ü—ã, —Ç–∏–ø—ã –∞—Ä–µ–Ω–¥—ã)
- –º–æ–¥–µ–ª–∏ –¥–∞–Ω–Ω—ã—Ö (Property, Booking, RatePlan, Agent)
- –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞ (VDS, Redis, Postgres, Celery, Nginx –∏ —Ç.–¥.)
- –ø—Ä–æ—Ü–µ—Å—Å—ã –∏ —Å–∏—Å—Ç–µ–º—ã (Content Machine, SERPAPI Monthly Keywords, Atmosphere Collector)

–°–≤—è–∑–∏ (edges), –ø—Ä–∏–º–µ—Ä—ã:
- "uses", "depends_on", "part_of", "deployed_on", "manages", "connects_to", "related_to".

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ ‚Äî –°–¢–†–û–ì–û JSON:

{
  "nodes": [
    {
      "label": "Command Center",
      "type": "service",
      "description": "Django-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è AI-–∞–≥–µ–Ω—Ç–∞–º–∏ –∏ MCP."
    }
  ],
  "edges": [
    {
      "source_label": "Command Center",
      "target_label": "filesystem MCP",
      "relation": "uses",
      "description": "Command Center –∏—Å–ø–æ–ª—å–∑—É–µ—Ç filesystem MCP –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏."
    }
  ]
}

–ï—Å–ª–∏ —Å—É—â–Ω–æ—Å—Ç–µ–π/—Å–≤—è–∑–µ–π –Ω–µ—Ç ‚Äî –≤–µ—Ä–Ω–∏ {"nodes": [], "edges": []}.
–ù–∏–∫–∞–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞ –≤–Ω–µ JSON.
```

### –ó–∞–¥–∞—á–∞ 3. –†–µ–∞–ª–∏–∑–∞—Ü–∏—è –ª–æ–≥–∏–∫–∏ –≤ `extract_graph_from_text`

* –í—ã–∑–≤–∞—Ç—å LLM (—á–µ—Ä–µ–∑ —Ç–≤–æ–π client / LLM registry).

* –†–∞—Å–ø–∞—Ä—Å–∏—Ç—å JSON (–æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫).

* –î–ª—è –∫–∞–∂–¥–æ–≥–æ `node`:

  * –ø–æ `(agent, label, type)` –Ω–∞–π—Ç–∏ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π `KnowledgeNode`:

    * –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–∏—Ç—å description (–Ω–µ –∑–∞—Ç–∏—Ä–∞—è –≤–∞–∂–Ω–æ–µ; –º–æ–∂–Ω–æ –º—ë—Ä–¥–∂–∏—Ç—å –ø–æ –ø—Ä–æ—Å—Ç–æ–º—É –ø—Ä–∞–≤–∏–ª—É: –µ—Å–ª–∏ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª–∏–Ω–Ω–µ–µ –∏ –Ω–µ –ø—É—Å—Ç–æ–π ‚Äî –æ–±–Ω–æ–≤–∏—Ç—å).
    * –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —É–∑–µ–ª.
  * –¥–ª—è –Ω–æ–≤—ã—Ö —É–∑–ª–æ–≤ —Å–æ–∑–¥–∞—Ç—å embedding —á–µ—Ä–µ–∑ `embed_text(description)`.

* –î–ª—è –∫–∞–∂–¥–æ–≥–æ `edge`:

  * –Ω–∞–π—Ç–∏ `source` –∏ `target` –ø–æ `(agent, label)` (–∏ –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏ type).
  * –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –Ω–µ –Ω–∞–π–¥–µ–Ω ‚Äî –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–≤—è–∑—å.
  * –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, —á—Ç–æ —Ç–∞–∫–æ–π edge —É–∂–µ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç (–ø–æ `agent, source, target, relation`).
  * –µ—Å–ª–∏ –Ω–µ—Ç ‚Äî —Å–æ–∑–¥–∞—Ç—å `KnowledgeEdge`.

---

## üß© Day 3 ‚Äî –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è Graph Extractor –≤ Memory pipeline

–¶–µ–ª—å: —á—Ç–æ–±—ã –∫–∞–∂–¥—ã–π –≤–∞–∂–Ω—ã–π `MemoryEvent` –º–æ–≥ –ø–æ—Ä–æ–∂–¥–∞—Ç—å –≥—Ä–∞—Ñ–æ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É.

### –ó–∞–¥–∞—á–∞ 1. –î–æ–±–∞–≤–∏—Ç—å —Ñ–ª–∞–≥ –≤ `MemoryEvent`

**–§–∞–π–ª:** `core/models.py`

* –ø–æ–ª–µ `graph_processed = models.BooleanField(default=False)`.

–ú–∏–≥—Ä–∞—Ü–∏—è, migrate.

### –ó–∞–¥–∞—á–∞ 2. Celery-–∑–∞–¥–∞—á–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≥—Ä–∞—Ñ–∞ –ø–æ MemoryEvent

**–§–∞–π–ª:** `core/tasks.py`

```python
@shared_task
def process_memory_event_graph(memory_event_id: int):
    """
    –ó–∞–≥—Ä—É–∂–∞–µ—Ç MemoryEvent, –∑–∞–ø—É—Å–∫–∞–µ—Ç graph_extractor.extract_graph_from_text,
    –ø–æ–º–µ—á–∞–µ—Ç event –∫–∞–∫ graph_processed=True.
    """
```

–õ–æ–≥–∏–∫–∞:

* –Ω–∞–π—Ç–∏ `MemoryEvent` –ø–æ id,
* –≤–∑—è—Ç—å `agent` –∏ `content`,
* –≤—ã–∑–≤–∞—Ç—å `extract_graph_from_text(agent, content)`,
* –æ—Ç–º–µ—Ç–∏—Ç—å `graph_processed = True`, —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å,
* –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (—Å–æ–∑–¥–∞–Ω–æ —É–∑–ª–æ–≤/—Å–≤—è–∑–µ–π).

### –ó–∞–¥–∞—á–∞ 3. –í—Å—Ç–∞–≤–∏—Ç—å –≤—ã–∑–æ–≤ `process_memory_event_graph` –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π Memory pipeline

* –£ —Ç–µ–±—è —É–∂–µ –µ—Å—Ç—å –∫–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –ø–æ—Å–ª–µ Memory Extractor —Å–æ–∑–¥–∞—ë—Ç MemoryEvent –∏ –∑–∞–ø—É—Å–∫–∞–µ—Ç `generate_memory_embedding_for_event`.
* –î–æ–ø–æ–ª–Ω–∏—Ç—å —ç—Ç–æ—Ç –∫–æ–¥ –∑–∞–ø—É—Å–∫–æ–º:

```python
process_memory_event_graph.delay(memory_event.id)
```

* –í–∞–∂–Ω–æ: —ç—Ç–æ –¥–æ–ª–∂–Ω–æ —Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –¥–ª—è –æ—Å–Ω–æ–≤–Ω—ã—Ö –∞–≥–µ–Ω—Ç–æ–≤, —Ç–∞–∫ –∏ –¥–ª—è –¥–µ–ª–µ–≥–∞—Ç–æ–≤.

---

## üß© Day 4 ‚Äî Graph Retrieval + AGENT GRAPH MEMORY

–¶–µ–ª—å: –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–æ–≤—É—é –ø–∞–º—è—Ç—å –ø—Ä–∏ –æ—Ç–≤–µ—Ç–∞—Ö –∞–≥–µ–Ω—Ç–∞.

### –ó–∞–¥–∞—á–∞ 1. –§—É–Ω–∫—Ü–∏—è `build_graph_memory_block(agent, query_text)`

**–§–∞–π–ª:** –Ω–æ–≤—ã–π –º–æ–¥—É–ª—å, –Ω–∞–ø—Ä–∏–º–µ—Ä `core/services/graph_memory.py`

```python
def build_graph_memory_block(agent: Agent, query_text: str, max_nodes: int = 5) -> str:
    """
    –î–µ–ª–∞–µ—Ç —ç–º–±–µ–¥–¥–∏–Ω–≥ query_text, –∏—â–µ—Ç top-K KnowledgeNode –ø–æ cosine distance,
    —Ä–∞—Å—à–∏—Ä—è–µ—Ç –∏—Ö –Ω–∞ 1‚Äì2 —Ö–æ–ø–∞ –ø–æ KnowledgeEdge,
    —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–π –±–ª–æ–∫ AGENT GRAPH MEMORY.
    –ï—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ ‚Äî –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É.
    """
```

–õ–æ–≥–∏–∫–∞:

1. `query_embedding = embed_text(query_text)`
2. `nodes_qs = KnowledgeNode.objects.filter(agent=agent).annotate(distance=CosineDistance("embedding", query_embedding)).order_by("distance")[:max_nodes]`
3. –î–ª—è –∫–∞–∂–¥–æ–≥–æ `node`:

   * —Å–æ–±—Ä–∞—Ç—å –µ–≥–æ –∏—Å—Ö–æ–¥—è—â–∏–µ –∏ –≤—Ö–æ–¥—è—â–∏–µ `KnowledgeEdge` (`out_edges`, `in_edges`) —Å `select_related("source", "target")`.
4. –°—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç:

```text
AGENT GRAPH MEMORY:

Nodes:
- [type=service] Command Center ‚Äî Django-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è AI-–∞–≥–µ–Ω—Ç–∞–º–∏ –∏ MCP.
- [type=mcp_server] filesystem MCP ‚Äî —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ñ–∞–π–ª–∞–º–∏ –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ web.

Relations:
- Command Center --uses--> filesystem MCP
- filesystem MCP --deployed_on--> VDS #1
```

5. –í–µ—Ä–Ω—É—Ç—å —Å—Ç—Ä–æ–∫—É (–∏–ª–∏ `""`, –µ—Å–ª–∏ —Å–ø–∏—Å–æ–∫ —É–∑–ª–æ–≤ –ø—É—Å—Ç).

### –ó–∞–¥–∞—á–∞ 2. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è –≤ `build_agent_llm_messages`

**–§–∞–π–ª:** `core/services/agent_context.py`

* –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è `user_message_text` –∏ –¥–æ –≤–æ–∑–≤—Ä–∞—Ç–∞ `messages`:

  * –≤—ã–∑–≤–∞—Ç—å `graph_block = build_graph_memory_block(agent, user_message_text)`
  * –µ—Å–ª–∏ `graph_block` –Ω–µ –ø—É—Å—Ç:

    * –¥–æ–±–∞–≤–∏—Ç—å –µ—â—ë –æ–¥–∏–Ω `system` message:

    ```python
    if graph_block:
        messages.append({"role": "system", "content": graph_block})
    ```

* –ú–æ–∂–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≥—Ä–∞—Ñ–∞ –æ—Ç–¥–µ–ª—å–Ω–æ (–ø–æ –∂–µ–ª–∞–Ω–∏—é ‚Äî –æ—Ç–¥–µ–ª—å–Ω—ã–π `GraphRetrievalLog`, –Ω–æ –¥–ª—è v1 –º–æ–∂–Ω–æ –Ω–µ –≤–≤–æ–¥–∏—Ç—å).

---

## üß© Day 5 ‚Äî UI / API –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä–∞—Ñ–∞

–¶–µ–ª—å: –≤–∏–¥–µ—Ç—å, —á—Ç–æ —Ö—Ä–∞–Ω–∏—Ç—Å—è –≤ –≥—Ä–∞—Ñ–µ, –∏ –∫–∞–∫ –æ–Ω –≤—ã–≥–ª—è–¥–∏—Ç.

### –ó–∞–¥–∞—á–∞ 1. API: —Å–ø–∏—Å–æ–∫ —É–∑–ª–æ–≤ –¥–ª—è –∞–≥–µ–Ω—Ç–∞

**–§–∞–π–ª:** `core/views.py` (–∏–ª–∏ `api_views.py`)

```python
class AgentGraphNodesView(View):
    """
    GET /api/agents/<id>/graph/nodes/?limit=100
    """
    def get(self, request, agent_id: int, *args, **kwargs):
        ...
```

–í–æ–∑–≤—Ä–∞—â–∞—Ç—å JSON:

```json
[
  {
    "id": "...",
    "label": "...",
    "type": "...",
    "description": "...",
    "object_type": "...",
    "object_id": "...",
    "created_at": "...",
    "updated_at": "..."
  },
  ...
]
```

### –ó–∞–¥–∞—á–∞ 2. API: —Å–ø–∏—Å–æ–∫ —Å–≤—è–∑–µ–π –¥–ª—è –∞–≥–µ–Ω—Ç–∞

```python
class AgentGraphEdgesView(View):
    """
    GET /api/agents/<id>/graph/edges/?limit=200
    """
```

–í–æ–∑–≤—Ä–∞—â–∞—Ç—å:

```json
[
  {
    "id": "...",
    "source_label": "...",
    "target_label": "...",
    "relation": "...",
    "description": "...",
    "weight": 1.0,
    "created_at": "..."
  }
]
```

### –ó–∞–¥–∞—á–∞ 3. –ü–∞–Ω–µ–ª—å –Ω–∞ –¥–∞—à–±–æ—Ä–¥–µ ‚ÄúGraph Memory‚Äù

**–§–∞–π–ª:** `templates/core/dashboard.html`

* –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π –±–ª–æ–∫/–≤–∫–ª–∞–¥–∫—É ‚ÄúGraph Memory‚Äù —Ä—è–¥–æ–º —Å ‚Äú–ü–∞–º—è—Ç—å –∞–≥–µ–Ω—Ç–∞‚Äù.
* –ü—Ä–∏ –≤—ã–±–æ—Ä–µ –∞–≥–µ–Ω—Ç–∞:

  * –¥–µ—Ä–≥–∞—Ç—å `GET /api/agents/<id>/graph/nodes/`,
  * –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É:

    * label, type, object_type/object_id, created_at.
* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ (–ø–æ –∂–µ–ª–∞–Ω–∏—é):

  * –ø–æ–¥ —Ç–∞–±–ª–∏—Ü–µ–π ‚Äî —Å–ø–∏—Å–æ–∫ edges (relation, source_label, target_label).

–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –≤ –≤–∏–¥–µ –≥—Ä–∞—Ñ–∞ (—É–∑–ª—ã-—Ç–æ—á–∫–∏, –ª–∏–Ω–∏–∏) –º–æ–∂–Ω–æ –æ—Ç–ª–æ–∂–∏—Ç—å –Ω–∞ v2 ‚Äî —Å–µ–π—á–∞—Å –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ç–∞–±–ª–∏—á–Ω–æ–≥–æ –≤–∏–¥–∞.

---

## üß© Day 6 ‚Äî –¢–µ—Å—Ç—ã –∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞

### –ó–∞–¥–∞—á–∞ 1. –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ unit-—Ç–µ—Å—Ç—ã –¥–ª—è Graph Extractor

* —Ç–µ—Å—Ç: –ø—Ä–∏ –∑–∞–¥–∞–Ω–Ω–æ–º MemoryEvent.content (—Ñ–µ–π–∫–æ–≤—ã–π —Ç–µ–∫—Å—Ç) `extract_graph_from_text` —Å–æ–∑–¥–∞—ë—Ç –æ–∂–∏–¥–∞–µ–º—ã–µ —É–∑–ª—ã/—Å–≤—è–∑–∏.
* —Ç–µ—Å—Ç: –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –≤—ã–∑–æ–≤ —Å —Ç–µ–º –∂–µ —Ç–µ–∫—Å—Ç–æ–º –Ω–µ —Å–æ–∑–¥–∞—ë—Ç –¥—É–±–ª–∏–∫–∞—Ç—ã —É–∑–ª–æ–≤/—Å–≤—è–∑–µ–π.

### –ó–∞–¥–∞—á–∞ 2. –¢–µ—Å—Ç Graph Retrieval

* —Å–æ–∑–¥–∞—Ç—å –ø–∞—Ä—É `KnowledgeNode` –∏ `KnowledgeEdge` —Ä—É–∫–∞–º–∏ –≤ —Ç–µ—Å—Ç–µ,
* –≤—ã–∑–≤–∞—Ç—å `build_graph_memory_block`,
* —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ:

  * –Ω—É–∂–Ω—ã–µ —É–∑–ª—ã –ø–æ–ø–∞–ª–∏ –≤ —Ç–µ–∫—Å—Ç,
  * –Ω—É–∂–Ω—ã–µ —Å–≤—è–∑–∏ –æ—Ç—Ä–∏—Å–æ–≤–∞–Ω—ã.

### –ó–∞–¥–∞—á–∞ 3. –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

* —É–±–µ–¥–∏—Ç—å—Å—è, —á—Ç–æ:

  * Graph Extractor –ª–æ–≥–∏—Ä—É–µ—Ç –æ—à–∏–±–∫–∏ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON,
  * `process_memory_event_graph` –ª–æ–≥–∏—Ä—É–µ—Ç —É—Å–ø–µ—à–Ω—ã–µ/–Ω–µ—É—Å–ø–µ—à–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç–∫–∏.

---

## üß© Day 7 ‚Äî Retention –¥–ª—è –≥—Ä–∞—Ñ–æ–≤–æ–π –ø–∞–º—è—Ç–∏

–¶–µ–ª—å: –Ω–µ –¥–æ–ø—É—Å—Ç–∏—Ç—å –±–µ—Å–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–≥–æ —Ä–æ—Å—Ç–∞ –≥—Ä–∞—Ñ–∞.

### –ó–∞–¥–∞—á–∞ 1. –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å —Ä–æ—Å—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —É–∑–ª–æ–≤/—Ä—ë–±–µ—Ä

* –í `core/tasks.py` –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–¥–∞—á—É:

```python
@shared_task
def cleanup_graph_memory():
    """
    - –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ KnowledgeNode –∏ KnowledgeEdge –Ω–∞ –∞–≥–µ–Ω—Ç–∞.
    - –ù–∞–ø—Ä–∏–º–µ—Ä:
      - max_nodes_per_agent = 2000
      - max_edges_per_agent = 5000
    - –£–¥–∞–ª—è–µ—Ç —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ —É–∑–ª—ã/—Ä—ë–±—Ä–∞ –Ω–∏–∑–∫–æ–π –≤–∞–∂–Ω–æ—Å—Ç–∏ (–µ—Å–ª–∏ importance –¥–ª—è —É–∑–ª–æ–≤ –Ω–µ –≤–≤–µ–¥—ë–Ω ‚Äî –ø—Ä–æ—Å—Ç–æ –ø–æ created_at).
    """
```

*–ù–∞ v1 –º–æ–∂–Ω–æ —Å—á–∏—Ç–∞—Ç—å, —á—Ç–æ –≤—Å–µ —É–∑–ª—ã —Ä–∞–≤–Ω—ã –ø–æ ‚Äú–≤–∞–∂–Ω–æ—Å—Ç–∏‚Äù –∏ —É–¥–∞–ª—è—Ç—å –ø–æ –¥–∞—Ç–µ.*

### –ó–∞–¥–∞—á–∞ 2. –ü–æ–¥–∫–ª—é—á–∏—Ç—å –≤ Celery beat

* —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏ –≤ 04:00:

```python
"cleanup-graph-memory-daily": {
    "task": "core.tasks.cleanup_graph_memory",
    "schedule": crontab(hour=4, minute=0),
}
```

### –ó–∞–¥–∞—á–∞ 3. –ë–∞–∑–æ–≤—ã–π –ª–æ–≥

* –ª–æ–≥–∏—Ä–æ–≤–∞—Ç—å:

  * —Å–∫–æ–ª—å–∫–æ —É–∑–ª–æ–≤/—Ä—ë–±–µ—Ä –±—ã–ª–æ –¥–æ,
  * —Å–∫–æ–ª—å–∫–æ —É–¥–∞–ª–µ–Ω–æ,
  * —Å–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å.

---

## ‚úÖ –ò—Ç–æ–≥

–≠—Ç–æ—Ç —Å–ø—Ä–∏–Ω—Ç:

* **–Ω–µ –ª–æ–º–∞–µ—Ç** —Ç–µ–∫—É—â—É—é –ø–∞–º—è—Ç—å (AgentMemory + MemoryEvent),
* –¥–æ–±–∞–≤–ª—è–µ—Ç **–≥—Ä–∞—Ñ–æ–≤—ã–π —Å–ª–æ–π**:

  * –º–æ–¥–µ–ª–∏ —É–∑–ª–æ–≤/—Å–≤—è–∑–µ–π,
  * LLM-extractor,
  * –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é –≤ pipeline,
  * retrieval –≤ –ø—Ä–æ–º–ø—Ç,
  * UI/observability,
  * retention –¥–ª—è –≥—Ä–∞—Ñ–∞.

---
